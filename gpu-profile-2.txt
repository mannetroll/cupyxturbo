$ scalene --cli --cpu -m scipyturbo.turbo_simulator_cufft 1024 10000 10 10001 0.75 gpu 2>&1
 Checking CuPy...
OS                           : Windows-10-10.0.19045-SP0
Python Version               : 3.13.11
CuPy Version                 : 13.6.0
CuPy Platform                : NVIDIA CUDA
NumPy Version                : 2.4.0
SciPy Version                : 1.16.3
Cython Build Version         : 3.0.12
Cython Runtime Version       : None
CUDA Root                    : C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1
nvcc PATH                    : C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1\bin\nvcc.EXE
CUDA Build Version           : 13000
CUDA Driver Version          : 13010
CUDA Runtime Version         : 13000 (linked to CuPy) / 13010 (locally installed)
CUDA Extra Include Dirs      : []
cuBLAS Version               : (available)
cuFFT Version                : 12100
cuRAND Version               : 10401
cuSOLVER Version             : (12, 0, 7)
cuSPARSE Version             : (available)
NVRTC Version                : (13, 1)
Thrust Version               : 200800
CUB Build Version            : 200800
Jitify Build Version         : 1a0ca0e
cuDNN Build Version          : None
cuDNN Version                : None
NCCL Build Version           : None
NCCL Runtime Version         : None
cuTENSOR Version             : None
cuSPARSELt Build Version     : None
Device 0 Name                : NVIDIA GeForce RTX 3090
Device 0 Compute Capability  : 86
Device 0 PCI Bus ID          : 0000:01:00.0
--- RUN DNS ---
 N   = 1024
 Re  = 10000.0
 K0  = 10.0
 Steps = 10001
 CFL  = 0.75
 requested = gpu
 backend:  gpu
 workers (CPU): 5
FFT plan_mod: cupyx.scipy.fft
--- INITIALIZING SciPy/CuPy --- 2026-01-04 14:50
 N=1024, K0=10, Re=10000.0
Generate isotropic random spectrum...
z=0/1024
z=1000/1024
Compute averages A(1..7), E110, Q2, W2, VISC...
 N           =        1024
 Reynolds n. =       1e+04
 K0          =          10
 Energy      =      0.9968
 WiWi        =    100.0000
 Epsilon     =      0.0997
 a11         =     -0.0000
 e11         =     -0.0000
 Time scale  =           5
 Kolmogorov  =      0.0100
 Viscosity   =      0.0010
 dx/Kol.     =      0.6146
 2Pi/Nlamda  =     18.7245
 2Pi/Lux     =     22.2496
 2Pi/Luz     =     38.5380
 2Pi/Lwx     =     38.5380
 2Pi/Lwz     =     22.2496
 Deps.       =      0.0397
 Ceps2       =      1.9936
 E1          =      1.0000
 E3          =      1.0000
 PAO seed    =        1983
 PAO initialization OK. VISC=0.0009968169
 effective = gpu (xp = cupy)
 scipy.fft workers in-context = 1
 [NEXTDT INIT] CFLM=   666.0746 DT=  0.0003584 CN=  1.0000000
 Initial DT=  0.0003584 CN=  1.0000000
 ITERATION      1 T=0.0000000000 DT=0.00035843 CN=1.00004586 CFLM=665.921875
 ITERATION    100 T=0.0354848880 DT=0.00036065 CN=1.00618562 CFLM=646.062561
 ITERATION    200 T=0.0715477219 DT=0.00036541 CN=1.01319982 CFLM=620.966248
 ITERATION    300 T=0.1080840647 DT=0.00037123 CN=1.01593189 CFLM=605.122009
 ITERATION    400 T=0.1452015151 DT=0.00037646 CN=1.01409411 CFLM=600.745361
 ITERATION    500 T=0.1828427743 DT=0.00038293 CN=1.01716954 CFLM=584.006897
 ITERATION    600 T=0.2211291748 DT=0.00039209 CN=1.02392315 CFLM=556.832458
 ITERATION    700 T=0.2603289640 DT=0.00039663 CN=1.01158621 CFLM=575.531128
 ITERATION    800 T=0.2999876543 DT=0.00039702 CN=1.00097960 CFLM=598.964783
 ITERATION    900 T=0.3396893531 DT=0.00039533 CN=0.99575093 CFLM=614.361816
 ITERATION   1000 T=0.3792244304 DT=0.00039312 CN=0.99439071 CFLM=621.300659
 ITERATION   1100 T=0.4185382842 DT=0.00039185 CN=0.99676793 CFLM=617.256897
 ITERATION   1200 T=0.4577241330 DT=0.00039156 CN=0.99926432 CFLM=611.500305
 ITERATION   1300 T=0.4968801720 DT=0.00039115 CN=0.99895407 CFLM=612.904785
 ITERATION   1400 T=0.5359953779 DT=0.00039166 CN=1.00131505 CFLM=606.350952
 ITERATION   1500 T=0.5751610979 DT=0.00039400 CN=1.00596802 CFLM=591.874695
 ITERATION   1600 T=0.6145587398 DT=0.00039565 CN=1.00418394 CFLM=593.504211
 ITERATION   1700 T=0.6541219179 DT=0.00039741 CN=1.00445109 CFLM=590.259094
 ITERATION   1800 T=0.6938610901 DT=0.00039999 CN=1.00648384 CFLM=581.858337
 ITERATION   1900 T=0.7338571203 DT=0.00039850 CN=0.99628949 CFLM=608.134277
 ITERATION   2000 T=0.7737087961 DT=0.00039379 CN=0.98818203 CFLM=636.697021
 ITERATION   2100 T=0.8130927489 DT=0.00038796 CN=0.98517749 CFLM=654.765564
 ITERATION   2200 T=0.8518941299 DT=0.00038213 CN=0.98498131 CFLM=665.321716
 ITERATION   2300 T=0.8901128421 DT=0.00037649 CN=0.98525616 CFLM=674.464172
 ITERATION   2400 T=0.9277679572 DT=0.00037055 CN=0.98420827 CFLM=688.451355
 ITERATION   2500 T=0.9648288335 DT=0.00036346 CN=0.98087804 CFLM=712.376404
 ITERATION   2600 T=1.0011822872 DT=0.00035532 CN=0.97758891 CFLM=739.715149
 ITERATION   2700 T=1.0367222393 DT=0.00034676 CN=0.97591465 CFLM=763.874634
 ITERATION   2800 T=1.0714068078 DT=0.00033850 CN=0.97618331 CFLM=781.533325
 ITERATION   2900 T=1.1052652091 DT=0.00033122 CN=0.97848165 CFLM=790.291504
 ITERATION   3000 T=1.1383942365 DT=0.00032550 CN=0.98273841 CFLM=788.857117
 ITERATION   3100 T=1.1709499634 DT=0.00032177 CN=0.98853614 CFLM=778.028748
 ITERATION   3200 T=1.2031305558 DT=0.00032031 CN=0.99548005 CFLM=759.093506
 ITERATION   3300 T=1.2351634333 DT=0.00032125 CN=1.00292942 CFLM=734.547913
 ITERATION   3400 T=1.2672877516 DT=0.00032455 CN=1.01027979 CFLM=706.801147
 ITERATION   3500 T=1.2997399468 DT=0.00033005 CN=1.01693891 CFLM=678.134216
 ITERATION   3600 T=1.3327397076 DT=0.00033746 CN=1.02244970 CFLM=650.318970
 ITERATION   3700 T=1.3664785146 DT=0.00034619 CN=1.02586206 CFLM=626.430664
 ITERATION   3800 T=1.4010887505 DT=0.00035514 CN=1.02584021 CFLM=610.697388
 ITERATION   3900 T=1.4365933294 DT=0.00036353 CN=1.02363451 CFLM=601.185913
 ITERATION   4000 T=1.4729378051 DT=0.00037119 CN=1.02107305 CFLM=594.110046
 ITERATION   4100 T=1.5100490793 DT=0.00037801 CN=1.01836445 CFLM=589.065979
 ITERATION   4200 T=1.5478428664 DT=0.00038361 CN=1.01482236 CFLM=587.980835
 ITERATION   4300 T=1.5861981613 DT=0.00038770 CN=1.01067648 CFLM=590.794678
 ITERATION   4400 T=1.6249645228 DT=0.00039042 CN=1.00700296 CFLM=594.927307
 ITERATION   4500 T=1.6640037729 DT=0.00039221 CN=1.00458917 CFLM=597.760315
 ITERATION   4600 T=1.7032231165 DT=0.00039364 CN=1.00364739 CFLM=597.781372
 ITERATION   4700 T=1.7425858761 DT=0.00039519 CN=1.00393012 CFLM=594.783203
 ITERATION   4800 T=1.7821032250 DT=0.00039723 CN=1.00517426 CFLM=588.862244
 ITERATION   4900 T=1.8218245572 DT=0.00040005 CN=1.00707883 CFLM=580.442932
 ITERATION   5000 T=1.8618263172 DT=0.00040373 CN=1.00921893 CFLM=570.467346
 ITERATION   5100 T=1.9021960003 DT=0.00040819 CN=1.01104945 CFLM=560.353577
 ITERATION   5200 T=1.9430110140 DT=0.00041318 CN=1.01220437 CFLM=551.213257
 ITERATION   5300 T=1.9843236828 DT=0.00041846 CN=1.01279907 CFLM=543.045288
 ITERATION   5400 T=2.0261648725 DT=0.00042395 CN=1.01311248 CFLM=535.394104
 ITERATION   5500 T=2.0685545746 DT=0.00042958 CN=1.01328495 CFLM=528.037292
 ITERATION   5600 T=2.1115073496 DT=0.00043531 CN=1.01331840 CFLM=521.032593
 ITERATION   5700 T=2.1550321728 DT=0.00044099 CN=1.01305658 CFLM=514.816345
 ITERATION   5800 T=2.1991253940 DT=0.00044584 CN=1.01100198 CFLM=513.129578
 ITERATION   5900 T=2.2437046224 DT=0.00044751 CN=1.00374808 CFLM=525.615356
 ITERATION   6000 T=2.2884541363 DT=0.00044788 CN=1.00081947 CFLM=531.289246
 ITERATION   6100 T=2.3332416269 DT=0.00044836 CN=1.00107828 CFLM=530.170959
 ITERATION   6200 T=2.3780772952 DT=0.00045008 CN=1.00382619 CFLM=522.460022
 ITERATION   6300 T=2.4230832828 DT=0.00045374 CN=1.00814028 CFLM=509.680939
 ITERATION   6400 T=2.4684536977 DT=0.00045647 CN=1.00600921 CFLM=510.795349
 ITERATION   6500 T=2.5140977119 DT=0.00045867 CN=1.00481673 CFLM=510.700378
 ITERATION   6600 T=2.5599621223 DT=0.00046057 CN=1.00415735 CFLM=509.893799
 ITERATION   6700 T=2.6060175080 DT=0.00046224 CN=1.00361205 CFLM=509.142670
 ITERATION   6800 T=2.6522394985 DT=0.00046355 CN=1.00283285 CFLM=509.259125
 ITERATION   6900 T=2.6985927878 DT=0.00046427 CN=1.00155453 CFLM=511.041290
 ITERATION   7000 T=2.7450187256 DT=0.00046420 CN=0.99985284 CFLM=514.592712
 ITERATION   7100 T=2.7914386204 DT=0.00046332 CN=0.99810464 CFLM=519.210205
 ITERATION   7200 T=2.8377713445 DT=0.00046182 CN=0.99677224 CFLM=523.718567
 ITERATION   7300 T=2.8839551361 DT=0.00046000 CN=0.99605825 CFLM=527.327881
 ITERATION   7400 T=2.9299572138 DT=0.00045811 CN=0.99588970 CFLM=529.870239
 ITERATION   7500 T=2.9757702869 DT=0.00045630 CN=0.99604563 CFLM=531.633972
 ITERATION   7600 T=3.0214021263 DT=0.00045459 CN=0.99625379 CFLM=533.178467
 ITERATION   7700 T=3.0668629238 DT=0.00045292 CN=0.99632585 CFLM=534.986938
 ITERATION   7800 T=3.1121566588 DT=0.00045131 CN=0.99643896 CFLM=536.650635
 ITERATION   7900 T=3.1572890493 DT=0.00044991 CN=0.99689958 CFLM=537.308594
 ITERATION   8000 T=3.2022813017 DT=0.00044901 CN=0.99799993 CFLM=535.984375
 ITERATION   8100 T=3.2471830697 DT=0.00044899 CN=0.99995671 CFLM=531.802856
 ITERATION   8200 T=3.2920820136 DT=0.00045025 CN=1.00280272 CFLM=524.362549
 ITERATION   8300 T=3.3371055188 DT=0.00045314 CN=1.00641471 CFLM=513.747009
 ITERATION   8400 T=3.3824162150 DT=0.00045788 CN=1.01045936 CFLM=500.662109
 ITERATION   8500 T=3.4281990109 DT=0.00046452 CN=1.01451984 CFLM=486.101166
 ITERATION   8600 T=3.4746447255 DT=0.00047295 CN=1.01814064 CFLM=471.191010
 ITERATION   8700 T=3.5219313373 DT=0.00048285 CN=1.02093353 CFLM=456.945251
 ITERATION   8800 T=3.5702065274 DT=0.00049382 CN=1.02272318 CFLM=443.979492
 ITERATION   8900 T=3.6195778371 DT=0.00050427 CN=1.02114778 CFLM=437.207550
 ITERATION   9000 T=3.6699940010 DT=0.00051348 CN=1.01827194 CFLM=433.794189
 ITERATION   9100 T=3.7213327862 DT=0.00052035 CN=1.01337965 CFLM=435.777557
 ITERATION   9200 T=3.7733609334 DT=0.00052335 CN=1.00577282 CFLM=445.920746
 ITERATION   9300 T=3.8256933356 DT=0.00052286 CN=0.99906174 CFLM=458.308594
 ITERATION   9400 T=3.8779801283 DT=0.00051971 CN=0.99396665 CFLM=470.789093
 ITERATION   9500 T=3.9299541231 DT=0.00051469 CN=0.99034910 CFLM=482.648346
 ITERATION   9600 T=3.9814284135 DT=0.00050856 CN=0.98808460 CFLM=493.219330
 ITERATION   9700 T=4.0322905443 DT=0.00050199 CN=0.98707663 CFLM=501.856628
 ITERATION   9800 T=4.0824958838 DT=0.00049559 CN=0.98725025 CFLM=507.955811
 ITERATION   9900 T=4.1320610294 DT=0.00048993 CN=0.98858401 CFLM=510.876831
 ITERATION  10000 T=4.1810596705 DT=0.00048553 CN=0.99102550 CFLM=510.171448
 ITERATION  10001 T=4.1815496003 DT=0.00048202 CN=0.99276466 CFLM=510.146912
 Elapsed CPU time for 10001 steps (s) =  16.1631
 Final T= 4.18204  CN=0.992765  DT=0.00048202
 FPS = 618.756
      C:\Users\tobbe\python\cupyxturbo\scipyturbo\turbo_simulator_cufft.py: % of time = 100.00% (21.281s) out of 21.281s.
+-----------------------------------------------------------------------------------------------------------------------------+
|       |Time    |–––––– |–––––– |                                                                                            |
| Line  |Python  |native |system |C:\Users\tobbe\python\cupyxturbo\scipyturbo\turbo_simulator_cufft.py                        |
|-------+--------+-------+-------+--------------------------------------------------------------------------------------------|
|     1 |        |       |       |"""                                                                                         |
|     2 |        |       |       |turbo_simulator.py â€” 2D Homogeneous Turbulence DNS (SciPy / CuPy port)                    |
|     3 |        |       |       |                                                                                            |
|     4 |        |       |       |This is a structural port of dns_all.cu to Python.                                          |
|     5 |        |       |       |                                                                                            |
|     6 |        |       |       |Key ideas kept from the CUDA version:                                                       |
|     7 |        |       |       |  â€¢ DnsState structure mirrors DnsDeviceState (Nbase, NX, NZ, NK, NX_full, NZ_full, NK_fu |
|     8 |        |       |       |  â€¢ UR (compact)  : shape (NZ, NX, 3)   â€” AoS: [z, x, comp]                             |
|     9 |        |       |       |  â€¢ UC (compact)  : shape (NZ, NK, 3)   â€” spectral, [z, kx, comp]                       |
|    10 |        |       |       |  â€¢ UR_full (3/2) : shape (3, NZ_full, NX_full)   â€” SoA: [comp, z, x]                   |
|    11 |        |       |       |  â€¢ UC_full (3/2) : shape (3, NZ_full, NK_full)   â€” spectral, SoA                       |
|    12 |        |       |       |  â€¢ om2, fnm1     : shape (NZ, NX_half) â€” spectral vorticity & non-linear term          |
|    13 |        |       |       |  â€¢ alfa[NX_half], gamma[NZ]           â€” wave-number vectors                            |
|    14 |        |       |       |  â€¢ Time loop     : STEP2B â†’ STEP3 â†’ STEP2A â†’ NEXTDT, like dns_all.cu               |
|    15 |        |       |       |                                                                                            |
|    16 |        |       |       |Backends:                                                                                   |
|    17 |        |       |       |  â€¢ CPU:  SciPy                                                                           |
|    18 |        |       |       |  â€¢ GPU:  CuPy (if installed); same API used via the `xp` alias.                          |
|    19 |        |       |       |                                                                                            |
|    20 |        |       |       |This is now a faithful structural port of dns_all.cu:                                       |
|    21 |        |       |       |                                                                                            |
|    22 |        |       |       |  â€¢ dnsCudaPaoHostInit  â†’ dns_pao_host_init                                             |
|    23 |        |       |       |  â€¢ dnsCudaCalcom       â†’ dns_calcom_from_uc_full                                       |
|    24 |        |       |       |  â€¢ dnsCudaStep2A/2B/3  â†’ dns_step2a / dns_step2b / dns_step3                           |
|    25 |        |       |       |  â€¢ next_dt_gpu         â†’ next_dt                                                       |
|    26 |        |       |       |                                                                                            |
|    27 |        |       |       |The 3/2 de-aliasing, Crankâ€“Nicolson update, and spectral vorticity                        |
|    28 |        |       |       |formulas follow the CUDA kernels line-by-line.                                              |
|    29 |        |       |       |"""                                                                                         |
|    30 |        |       |       |from contextlib import nullcontext                                                          |
|    31 |        |       |       |import time                                                                                 |
|    32 |        |       |       |import datetime as _dt                                                                      |
|    33 |        |       |       |import math                                                                                 |
|    34 |        |       |       |import sys                                                                                  |
|    35 |        |       |       |from dataclasses import dataclass                                                           |
|    36 |        |       |       |from typing import Literal                                                                  |
|    37 |        |       |       |                                                                                            |
|    38 |        |       |       |import numpy as _np                                                                         |
|    39 |        |       |       |                                                                                            |
|    40 |        |       |       |try:                                                                                        |
|    41 |        |       |       |    print(" Checking CuPy...")                                                              |
|    42 |        |       |       |    import cupy as _cp                                                                      |
|    43 |        |       |       |    _cp.show_config()                                                                       |
|    44 |        |       |       |    _cflm_max_abs_sum = None                                                                |
|    45 |        |       |       |    if _cp is not None:                                                                     |
|    46 |        |       |       |        _cflm_max_abs_sum = _cp.ReductionKernel(                                            |
|    47 |        |       |       |            in_params="float32 u, float32 w",                                               |
|    48 |        |       |       |            out_params="float32 out",                                                       |
|    49 |        |       |       |            map_expr="fabsf(u) + fabsf(w)",                                                 |
|    50 |        |       |       |            reduce_expr="max(a, b)",                                                        |
|    51 |        |       |       |            post_map_expr="out = a",                                                        |
|    52 |        |       |       |            identity="0.0f",                                                                |
|    53 |        |       |       |            name="cflm_max_abs_sum",                                                        |
|    54 |        |       |       |        )                                                                                   |
|    55 |        |       |       |except Exception:  # CuPy is optional                                                       |
|    56 |        |       |       |    _cp = None                                                                              |
|    57 |        |       |       |    print(" CuPy not installed")                                                            |
|    58 |        |       |       |                                                                                            |
|    59 |        |       |       |import numpy as np  # in addition to your existing _np alias, this is fine                  |
|    60 |        |       |       |                                                                                            |
|    61 |        |       |       |# ===============================================================                           |
|    62 |        |       |       |# ONLY FFT selection (CPU: scipy.fft, GPU: cupyx.scipy.fft)                                 |
|    63 |        |       |       |# ===============================================================                           |
|    64 |        |       |       |try:                                                                                        |
|    65 |        |       |       |    import scipy.fft as _spfft  # type: ignore                                              |
|    66 |        |       |       |except Exception:                                                                           |
|    67 |        |       |       |    _spfft = None                                                                           |
|    68 |        |       |       |                                                                                            |
|    69 |        |       |       |try:                                                                                        |
|    70 |        |       |       |    import cupyx.scipy.fft as _cpfft  # type: ignore                                        |
|    71 |        |       |       |except Exception:                                                                           |
|    72 |        |       |       |    _cpfft = None                                                                           |
|    73 |        |       |       |                                                                                            |
|    74 |        |       |       |                                                                                            |
|    75 |        |       |       |def _fft_mod_for_state(S: "DnsState"):                                                      |
|    76 |        |       |       |    """                                                                                     |
|    77 |        |       |       |    ONLY FFT selection:                                                                     |
|    78 |        |       |       |      - CPU: scipy.fft                                                                      |
|    79 |        |       |       |      - GPU: cupyx.scipy.fft (fallback to cupy.fft if cupyx.scipy.fft is unavailable)       |
|    80 |        |       |       |    """                                                                                     |
|    81 |        |       |       |    if S.backend == "gpu":                                                                  |
|    82 |        |       |       |        if _cpfft is not None:                                                              |
|    83 |        |       |       |            return _cpfft                                                                   |
|    84 |        |       |       |        return S.xp.fft                                                                     |
|    85 |        |       |       |    return _spfft                                                                           |
|    86 |        |       |       |                                                                                            |
|    87 |        |       |       |# ===============================================================                           |
|    88 |        |       |       |# Fortran-style random generator used in PAO (port of frand)                                |
|    89 |        |       |       |# ===============================================================                           |
|    90 |        |       |       |def frand(seed_list):                                                                       |
|    91 |        |       |       |    """                                                                                     |
|    92 |        |       |       |    Port of the Fortran LCG used in PAO:                                                    |
|    93 |        |       |       |                                                                                            |
|    94 |        |       |       |      IMM = 420029                                                                          |
|    95 |        |       |       |      IT  = 2017                                                                            |
|    96 |        |       |       |      ID  = 5011                                                                            |
|    97 |        |       |       |                                                                                            |
|    98 |        |       |       |      seed = (seed*IMM + IT) mod ID                                                         |
|    99 |        |       |       |      r    = seed / ID                                                                      |
|   100 |        |       |       |                                                                                            |
|   101 |        |       |       |    `seed_list` is a 1-element list to mimic Fortran SAVE/INTENT(INOUT).                    |
|   102 |        |       |       |    """                                                                                     |
|   103 |        |       |       |    IMM = 420029                                                                            |
|   104 |        |       |       |    IT = 2017                                                                               |
|   105 |        |       |       |    ID = 5011                                                                               |
|   106 |        |       |       |                                                                                            |
|   107 |        |       |       |    seed_list[0] = (seed_list[0] * IMM + IT) % ID                                           |
|   108 |        |       |       |    return np.float32(seed_list[0] / ID)                                                    |
|   109 |        |       |       |                                                                                            |
|   110 |        |       |       |                                                                                            |
|   111 |        |       |       |# ---------------------------------------------------------------------------               |
|   112 |        |       |       |# Backend selection: xp = np (CPU) or cp (GPU, if available)                                |
|   113 |        |       |       |# ---------------------------------------------------------------------------               |
|   114 |        |       |       |def get_xp(backend: Literal["cpu", "gpu", "auto"] = "auto"):                                |
|   115 |        |       |       |    """                                                                                     |
|   116 |        |       |       |    backend = "gpu"  â†’ force CuPy cuFFT (error if not available)                          |
|   117 |        |       |       |    backend = "cpu"  â†’ force SciPy FFT                                                    |
|   118 |        |       |       |    backend = "auto" â†’ use CuPy if available and a GPU is present, else SciPy             |
|   119 |        |       |       |    """                                                                                     |
|   120 |        |       |       |    # Auto-select: try GPU first                                                            |
|   121 |        |       |       |    if backend == "auto":                                                                   |
|   122 |        |       |       |        if _cp is not None:                                                                 |
|   123 |        |       |       |            return _cp                                                                      |
|   124 |        |       |       |        return _np                                                                          |
|   125 |        |       |       |                                                                                            |
|   126 |        |       |       |    # Explicit GPU / CPU selection                                                          |
|   127 |        |       |       |    if backend == "gpu":                                                                    |
|   128 |        |       |       |        if _cp is None:                                                                     |
|   129 |        |       |       |            raise RuntimeError("CuPy is not installed, but backend='gpu' was requested.")   |
|   130 |        |       |       |        return _cp                                                                          |
|   131 |        |       |       |                                                                                            |
|   132 |        |       |       |    # backend == "cpu"                                                                      |
|   133 |        |       |       |    return _np                                                                              |
|   134 |        |       |       |                                                                                            |
|   135 |        |       |       |                                                                                            |
|   136 |        |       |       |# ---------------------------------------------------------------------------               |
|   137 |        |       |       |# Fortran-style random generator used in PAO, port of frand(seed)                           |
|   138 |        |       |       |# ---------------------------------------------------------------------------               |
|   139 |        |       |       |                                                                                            |
|   140 |        |       |       |class Frand:                                                                                |
|   141 |        |       |       |    """                                                                                     |
|   142 |        |       |       |    Port of the tiny LCG from dns_all.cu:                                                   |
|   143 |        |       |       |                                                                                            |
|   144 |        |       |       |      IMM = 420029                                                                          |
|   145 |        |       |       |      IT  = 2017                                                                            |
|   146 |        |       |       |      ID  = 5011                                                                            |
|   147 |        |       |       |                                                                                            |
|   148 |        |       |       |      seed = (seed*IMM + IT) % ID                                                           |
|   149 |        |       |       |      r    = seed / ID                                                                      |
|   150 |        |       |       |    """                                                                                     |
|   151 |        |       |       |    IMM = 420029                                                                            |
|   152 |        |       |       |    IT = 2017                                                                               |
|   153 |        |       |       |    ID = 5011                                                                               |
|   154 |        |       |       |                                                                                            |
|   155 |        |       |       |    def __init__(self, seed: int = 1):                                                      |
|   156 |        |       |       |        self.seed = int(seed)                                                               |
|   157 |        |       |       |                                                                                            |
|   158 |        |       |       |    def __call__(self) -> float:                                                            |
|   159 |        |       |       |        self.seed = (self.seed * self.IMM + self.IT) % self.ID                              |
|   160 |        |       |       |        return float(self.seed) / float(self.ID)                                            |
|   161 |        |       |       |                                                                                            |
|   162 |        |       |       |                                                                                            |
|   163 |        |       |       |# ===============================================================                           |
|   164 |        |       |       |# Python equivalent of dnsCudaDumpUCFullCsv                                                 |
|   165 |        |       |       |# ===============================================================                           |
|   166 |        |       |       |def dump_uc_full_csv(S: "DnsState", UC_full, comp: int):                                    |
|   167 |        |       |       |    """                                                                                     |
|   168 |        |       |       |    CSV dumper compatible with step2a_debug.py, but for SoA layout:                         |
|   169 |        |       |       |                                                                                            |
|   170 |        |       |       |        UC_full: (3, NZ_full, NK_full)  # [comp, z, kx]                                     |
|   171 |        |       |       |                                                                                            |
|   172 |        |       |       |    We print NX_full rows, NZ_full columns:                                                 |
|   173 |        |       |       |      - For i < 2*ND2:                                                                      |
|   174 |        |       |       |          kx       = i // 2                                                                 |
|   175 |        |       |       |          imag_row = (i & 1) == 1                                                           |
|   176 |        |       |       |          value    = Re or Im of UC_full[comp, z, kx]                                       |
|   177 |        |       |       |      - For i >= 2*ND2, we print 0.0 (as in the debug helper).                              |
|   178 |        |       |       |    """                                                                                     |
|   179 |        |       |       |    N = S.Nbase                                                                             |
|   180 |        |       |       |    NX_full = S.NX_full                                                                     |
|   181 |        |       |       |    NZ_full = S.NZ_full                                                                     |
|   182 |        |       |       |    NK_full = S.NK_full                                                                     |
|   183 |        |       |       |    ND2 = N // 2                                                                            |
|   184 |        |       |       |                                                                                            |
|   185 |        |       |       |    # Bring data to NumPy on CPU for printing                                               |
|   186 |        |       |       |    if S.backend == "gpu":                                                                  |
|   187 |        |       |       |        UC_local = _np.asarray(UC_full.get())                                               |
|   188 |        |       |       |    else:                                                                                   |
|   189 |        |       |       |        UC_local = _np.asarray(UC_full)                                                     |
|   190 |        |       |       |                                                                                            |
|   191 |        |       |       |    for i in range(NX_full):                                                                |
|   192 |        |       |       |        row_vals = []                                                                       |
|   193 |        |       |       |                                                                                            |
|   194 |        |       |       |        use_mode = (i < 2 * ND2)                                                            |
|   195 |        |       |       |        if use_mode:                                                                        |
|   196 |        |       |       |            kx = i // 2           # 0..ND2-1                                                |
|   197 |        |       |       |            imag_row = (i & 1) == 1                                                         |
|   198 |        |       |       |        else:                                                                               |
|   199 |        |       |       |            kx = None                                                                       |
|   200 |        |       |       |            imag_row = False  # unused                                                      |
|   201 |        |       |       |                                                                                            |
|   202 |        |       |       |        for z in range(NZ_full):                                                            |
|   203 |        |       |       |            if use_mode and kx < NK_full:                                                   |
|   204 |        |       |       |                # SoA layout: [comp, z, kx]                                                 |
|   205 |        |       |       |                v = UC_local[comp, z, kx]                                                   |
|   206 |        |       |       |                val = float(v.imag if imag_row else v.real)                                 |
|   207 |        |       |       |            else:                                                                           |
|   208 |        |       |       |                val = 0.0                                                                   |
|   209 |        |       |       |                                                                                            |
|   210 |        |       |       |            row_vals.append(f"{val:10.5f}")                                                 |
|   211 |        |       |       |                                                                                            |
|   212 |        |       |       |        print(",".join(row_vals))                                                           |
|   213 |        |       |       |                                                                                            |
|   214 |        |       |       |    print(f"[CSV] Wrote UC_full, {NX_full}x{NZ_full}, comp={comp}")                         |
|   215 |        |       |       |                                                                                            |
|   216 |        |       |       |                                                                                            |
|   217 |        |       |       |# ---------------------------------------------------------------------------               |
|   218 |        |       |       |# DNS state  (Python equivalent of DnsDeviceState)                                          |
|   219 |        |       |       |# ---------------------------------------------------------------------------               |
|   220 |        |       |       |                                                                                            |
|   221 |        |       |       |@dataclass                                                                                  |
|   222 |        |       |       |class DnsState:                                                                             |
|   223 |        |       |       |    xp: any                 # scipy or cupy module                                          |
|   224 |        |       |       |    backend: str            # "cpu" or "gpu"                                                |
|   225 |        |       |       |                                                                                            |
|   226 |        |       |       |    Nbase: int              # Fortran NX=NZ                                                 |
|   227 |        |       |       |    NX: int                                                                                 |
|   228 |        |       |       |    NZ: int                                                                                 |
|   229 |        |       |       |    NK: int                                                                                 |
|   230 |        |       |       |                                                                                            |
|   231 |        |       |       |    NX_full: int                                                                            |
|   232 |        |       |       |    NZ_full: int                                                                            |
|   233 |        |       |       |    NK_full: int                                                                            |
|   234 |        |       |       |                                                                                            |
|   235 |        |       |       |    Re: float                                                                               |
|   236 |        |       |       |    K0: float                                                                               |
|   237 |        |       |       |    visc: float             # viscosity                                                     |
|   238 |        |       |       |    cflnum: float           # CFL target                                                    |
|   239 |        |       |       |    seed_init: int = 1                                                                      |
|   240 |        |       |       |    fft_workers: int = 1                                                                    |
|   241 |        |       |       |                                                                                            |
|   242 |        |       |       |    # Cached FFT module (scipy.fft or cupyx.scipy.fft)                                      |
|   243 |        |       |       |    fft: any = None                                                                         |
|   244 |        |       |       |                                                                                            |
|   245 |        |       |       |    # Reusable cuFFT plans (GPU only)                                                       |
|   246 |        |       |       |    fft_plan_rfft2_ur_full: any = None                                                      |
|   247 |        |       |       |    fft_plan_irfft2_uc01: any = None                                                        |
|   248 |        |       |       |                                                                                            |
|   249 |        |       |       |    # Precomputed grid constants for CFL computation (dx==dz==2*pi/N)                       |
|   250 |        |       |       |    inv_dx: float = 0.0                                                                     |
|   251 |        |       |       |                                                                                            |
|   252 |        |       |       |    # CFL scratch to avoid per-step allocations (full 3/2 grid)                             |
|   253 |        |       |       |    cfl_tmp: any = None                                                                     |
|   254 |        |       |       |    cfl_absw: any = None                                                                    |
|   255 |        |       |       |                                                                                            |
|   256 |        |       |       |    # Time integration                                                                      |
|   257 |        |       |       |    t: float = 0.0                                                                          |
|   258 |        |       |       |    dt: float = 0.0                                                                         |
|   259 |        |       |       |    cn: float = 1.0                                                                         |
|   260 |        |       |       |    cnm1: float = 0.0                                                                       |
|   261 |        |       |       |    it: int = 0                                                                             |
|   262 |        |       |       |                                                                                            |
|   263 |        |       |       |    # Spectral wavenumber vectors                                                           |
|   264 |        |       |       |    alfa: any = None        # shape (NX_half,)                                              |
|   265 |        |       |       |    gamma: any = None       # shape (NZ,)                                                   |
|   266 |        |       |       |                                                                                            |
|   267 |        |       |       |    # Compact grid (AoS)                                                                    |
|   268 |        |       |       |    ur: any = None          # shape (NZ, NX, 3), real                                       |
|   269 |        |       |       |    uc: any = None          # shape (NZ, NK, 3), complex                                    |
|   270 |        |       |       |                                                                                            |
|   271 |        |       |       |    # Full 3/2 grid (SoA)                                                                   |
|   272 |        |       |       |    ur_full: any = None     # shape (3, NZ_full, NX_full), real                             |
|   273 |        |       |       |    uc_full: any = None     # shape (3, NZ_full, NK_full), complex                          |
|   274 |        |       |       |                                                                                            |
|   275 |        |       |       |    # Vorticity and non-linear history                                                      |
|   276 |        |       |       |    om2: any = None         # shape (NZ, NX_half), complex                                  |
|   277 |        |       |       |    fnm1: any = None        # shape (NZ, NX_half), complex                                  |
|   278 |        |       |       |                                                                                            |
|   279 |        |       |       |    scratch1: any = None                                                                    |
|   280 |        |       |       |    scratch2: any = None                                                                    |
|   281 |        |       |       |                                                                                            |
|   282 |        |       |       |    # Precomputed index grids for STEP3 (avoid per-step allocations)                        |
|   283 |        |       |       |    step3_z_indices: any = None                                                             |
|   284 |        |       |       |    step3_kx_indices: any = None                                                            |
|   285 |        |       |       |    step3_z_spec: any = None                                                                |
|   286 |        |       |       |                                                                                            |
|   287 |        |       |       |    # STEP3 scratch buffers & constants (avoid per-step allocations)                        |
|   288 |        |       |       |    step3_uc1_th: any = None                                                                |
|   289 |        |       |       |    step3_uc2_th: any = None                                                                |
|   290 |        |       |       |    step3_uc3_th: any = None                                                                |
|   291 |        |       |       |                                                                                            |
|   292 |        |       |       |    step3_K2: any = None          # float32 (NZ, NX_half)                                   |
|   293 |        |       |       |    step3_GA: any = None          # float32 (NZ, NX_half)                                   |
|   294 |        |       |       |    step3_G2mA2: any = None       # float32 (NZ, NX_half)                                   |
|   295 |        |       |       |    step3_invK2_sub: any = None   # float32 (NZ, NX_half-1)                                 |
|   296 |        |       |       |                                                                                            |
|   297 |        |       |       |    step3_ARG: any = None         # float32 (NZ, NX_half)                                   |
|   298 |        |       |       |    step3_DEN: any = None         # float32 (NZ, NX_half)                                   |
|   299 |        |       |       |    step3_NUM: any = None         # complex64 (NZ, NX_half)                                 |
|   300 |        |       |       |                                                                                            |
|   301 |        |       |       |    step3_mask_ix0: any = None    # bool (NZ,)                                              |
|   302 |        |       |       |    step3_inv_gamma0: any = None  # float32 (NZ,)  precomputed 1/gamma for ix=0 branch (0 w |
|   303 |        |       |       |    step3_divxz: any = None       # float32 scalar                                          |
|   304 |        |       |       |                                                                                            |
|   305 |        |       |       |    def sync(self):                                                                         |
|   306 |        |       |       |        """For a CuPy backend, force synchronization at convenient checkpoints."""          |
|   307 |        |       |       |        if self.backend == "gpu":                                                           |
|   308 |        |       |       |            self.xp.cuda.Stream.null.synchronize()  # type: ignore[attr-defined]            |
|   309 |        |       |       |                                                                                            |
|   310 |        |       |       |                                                                                            |
|   311 |        |       |       |# ---------------------------------------------------------------------------               |
|   312 |        |       |       |# Helper to create a DnsState (dnsCudaInit equivalent)                                      |
|   313 |        |       |       |# ---------------------------------------------------------------------------               |
|   314 |        |       |       |                                                                                            |
|   315 |        |       |       |def create_dns_state(                                                                       |
|   316 |        |       |       |    N: int = 8,                                                                             |
|   317 |        |       |       |    Re: float = 1e5,                                                                        |
|   318 |        |       |       |    K0: float = 100.0,                                                                      |
|   319 |        |       |       |    CFL: float = 0.75,                                                                      |
|   320 |        |       |       |    backend: Literal["cpu", "gpu", "auto"] = "auto",                                        |
|   321 |        |       |       |    seed: int = 1,                                                                          |
|   322 |        |       |       |) -> DnsState:                                                                              |
|   323 |        |       |       |    xp = get_xp(backend)                                                                    |
|   324 |        |       |       |                                                                                            |
|   325 |        |       |       |    if backend == "auto":                                                                   |
|   326 |        |       |       |        effective_backend = "gpu" if (_cp is not None and xp is _cp) else "cpu"             |
|   327 |        |       |       |    else:                                                                                   |
|   328 |        |       |       |        effective_backend = backend                                                         |
|   329 |        |       |       |                                                                                            |
|   330 |        |       |       |    print(f" backend:  {backend}")                                                          |
|   331 |        |       |       |    Nbase = N                                                                               |
|   332 |        |       |       |    NX = N                                                                                  |
|   333 |        |       |       |    NZ = N                                                                                  |
|   334 |        |       |       |                                                                                            |
|   335 |        |       |       |    # Your CUDA code uses 3*N/2 (full 3/2 grid)                                             |
|   336 |        |       |       |    NX_full = 3 * NX // 2                                                                   |
|   337 |        |       |       |    NZ_full = 3 * NZ // 2                                                                   |
|   338 |        |       |       |    NK_full = NX_full // 2 + 1                                                              |
|   339 |        |       |       |                                                                                            |
|   340 |        |       |       |    # Compact spectral NK:                                                                  |
|   341 |        |       |       |    # For the original PAO/Calcom you used NK = 3*N/4 + 1; we keep that here.               |
|   342 |        |       |       |    NK = 3 * NX // 4 + 1                                                                    |
|   343 |        |       |       |                                                                                            |
|   344 |        |       |       |    NX_half = NX // 2                                                                       |
|   345 |        |       |       |                                                                                            |
|   346 |        |       |       |    # Viscosity: in your original Fortran/CUDA this is computed more carefully              |
|   347 |        |       |       |    # from PAO/Calcom; here we keep a standard DNS-ish scaling Î½ ~ 1/Re.                   |
|   348 |        |       |       |    visc = 1.0 / float(Re)                                                                  |
|   349 |        |       |       |                                                                                            |
|   350 |        |       |       |    state = DnsState(                                                                       |
|   351 |        |       |       |        xp=xp,                                                                              |
|   352 |        |       |       |        backend=effective_backend,                                                          |
|   353 |        |       |       |        Nbase=Nbase,                                                                        |
|   354 |        |       |       |        NX=NX,                                                                              |
|   355 |        |       |       |        NZ=NZ,                                                                              |
|   356 |        |       |       |        NK=NK,                                                                              |
|   357 |        |       |       |        NX_full=NX_full,                                                                    |
|   358 |        |       |       |        NZ_full=NZ_full,                                                                    |
|   359 |        |       |       |        NK_full=NK_full,                                                                    |
|   360 |        |       |       |        Re=Re,                                                                              |
|   361 |        |       |       |        K0=K0,                                                                              |
|   362 |        |       |       |        visc=visc,                                                                          |
|   363 |        |       |       |        cflnum=CFL,                                                                         |
|   364 |        |       |       |        seed_init=int(seed),                                                                |
|   365 |        |       |       |        fft_workers=5,                                                                      |
|   366 |        |       |       |    )                                                                                       |
|   367 |        |       |       |    print(f" workers (CPU): {state.fft_workers}")                                           |
|   368 |        |       |       |                                                                                            |
|   369 |        |       |       |    # Cache FFT module for the chosen backend (avoid per-call selection)                    |
|   370 |        |       |       |    state.fft = _fft_mod_for_state(state)                                                   |
|   371 |        |       |       |    if state.backend == "cpu" and state.fft is None:                                        |
|   372 |        |       |       |        raise RuntimeError("scipy.fft import failed; CPU backend requires SciPy.")          |
|   373 |        |       |       |                                                                                            |
|   374 |        |       |       |    # Precompute inverse grid spacing (dx==dz==2*pi/N)                                      |
|   375 |        |       |       |    state.inv_dx = float(state.Nbase) / (2.0 * math.pi)                                     |
|   376 |        |       |       |                                                                                            |
|   377 |        |       |       |    # Allocate arrays                                                                       |
|   378 |        |       |       |    state.ur = xp.zeros((NZ, NX, 3), dtype=xp.float32)                                      |
|   379 |        |       |       |    state.uc = xp.zeros((NZ, NK, 3), dtype=xp.complex64)                                    |
|   380 |        |       |       |                                                                                            |
|   381 |        |       |       |    state.ur_full = xp.zeros((3, NZ_full, NX_full), dtype=xp.float32)                       |
|   382 |        |       |       |    state.uc_full = xp.zeros((3, NZ_full, NK_full), dtype=xp.complex64)                     |
|   383 |        |       |       |                                                                                            |
|   384 |        |       |       |    # CFL scratch buffers (full 3/2 grid) to avoid per-step temporaries                     |
|   385 |        |       |       |    state.cfl_tmp = xp.empty((NZ_full, NX_full), dtype=xp.float32)                          |
|   386 |        |       |       |    state.cfl_absw = xp.empty((NZ_full, NX_full), dtype=xp.float32)                         |
|   387 |        |       |       |                                                                                            |
|   388 |        |       |       |    state.om2 = xp.zeros((NZ, NX_half), dtype=xp.complex64)                                 |
|   389 |        |       |       |    state.fnm1 = xp.zeros((NZ, NX_half), dtype=xp.complex64)                                |
|   390 |        |       |       |                                                                                            |
|   391 |        |       |       |    state.alfa = xp.zeros((NX_half,), dtype=xp.float32)                                     |
|   392 |        |       |       |    state.gamma = xp.zeros((NZ,), dtype=xp.float32)                                         |
|   393 |        |       |       |                                                                                            |
|   394 |        |       |       |    # Reusable cuFFT plans (GPU only)                                                       |
|   395 |        |       |       |    if state.backend == "gpu":                                                              |
|   396 |        |       |       |        plan_mod = None                                                                     |
|   397 |        |       |       |        if _cpfft is not None and hasattr(_cpfft, "get_fft_plan"):                          |
|   398 |        |       |       |            plan_mod = _cpfft                                                               |
|   399 |        |       |       |                                                                                            |
|   400 |        |       |       |        if plan_mod is not None:                                                            |
|   401 |        |       |       |            # Forward: rfft2 on real UR_full over (z,x) axes                                |
|   402 |        |       |       |            state.fft_plan_rfft2_ur_full = plan_mod.get_fft_plan(                           |
|   403 |        |       |       |                state.ur_full, axes=(1, 2), value_type="R2C"                                |
|   404 |        |       |       |            )                                                                               |
|   405 |        |       |       |            # Inverse: irfft2 on UC_full[0:2] over (z,x) axes back to real                  |
|   406 |        |       |       |            state.fft_plan_irfft2_uc01 = plan_mod.get_fft_plan(                             |
|   407 |        |       |       |                state.uc_full[0:2],                                                         |
|   408 |        |       |       |                shape=(state.NZ_full, state.NX_full),                                       |
|   409 |        |       |       |                axes=(1, 2),                                                                |
|   410 |        |       |       |                value_type="C2R",                                                           |
|   411 |        |       |       |            )                                                                               |
|   412 |        |       |       |                                                                                            |
|   413 |        |       |       |        if plan_mod is None:                                                                |
|   414 |        |       |       |            print("FFT plan_mod: None")                                                     |
|   415 |        |       |       |        else:                                                                               |
|   416 |        |       |       |            print(f"FFT plan_mod: {plan_mod.__name__}")                                     |
|   417 |        |       |       |                                                                                            |
|   418 |        |       |       |    # PAO-style initialization (dnsCudaPaoHostInit)                                         |
|   419 |        |       |       |    dns_pao_host_init(state)                                                                |
|   420 |        |       |       |                                                                                            |
|   421 |        |       |       |    # DT and CN will be initialized in run_dns via CFL (like CUDA)                          |
|   422 |        |       |       |    state.dt = 0.0                                                                          |
|   423 |        |       |       |    state.cn = 1.0                                                                          |
|   424 |        |       |       |    state.cnm1 = 0.0                                                                        |
|   425 |        |       |       |                                                                                            |
|   426 |        |       |       |    state.scratch1 = xp.zeros((NZ, NX_half), dtype=xp.complex64)                            |
|   427 |        |       |       |    state.scratch2 = xp.zeros((NZ, NX_half), dtype=xp.complex64)                            |
|   428 |        |       |       |                                                                                            |
|   429 |        |       |       |    # Precompute index grids used in STEP3 (avoid per-step allocations)                     |
|   430 |        |       |       |    NZ = state.NZ                                                                           |
|   431 |        |       |       |    NX_half = state.NX // 2                                                                 |
|   432 |        |       |       |    state.step3_z_indices = xp.arange(NZ, dtype=xp.int32)                                   |
|   433 |        |       |       |    state.step3_kx_indices = xp.arange(NX_half, dtype=xp.int32)                             |
|   434 |        |       |       |    NZ_half = NZ // 2                                                                       |
|   435 |        |       |       |    zi = state.step3_z_indices                                                              |
|   436 |        |       |       |    state.step3_z_spec = xp.where(                                                          |
|   437 |        |       |       |        zi <= (NZ_half - 1),                                                                |
|   438 |        |       |       |        zi,                                                                                 |
|   439 |        |       |       |        zi + NZ_half,                                                                       |
|   440 |        |       |       |    )                                                                                       |
|   441 |        |       |       |                                                                                            |
|   442 |        |       |       |    # STEP3: preallocate gather buffers for UC low-k band (avoid advanced-index allocs)     |
|   443 |        |       |       |    state.step3_uc1_th = xp.empty((NZ, NX_half), dtype=xp.complex64)                        |
|   444 |        |       |       |    state.step3_uc2_th = xp.empty((NZ, NX_half), dtype=xp.complex64)                        |
|   445 |        |       |       |    state.step3_uc3_th = xp.empty((NZ, NX_half), dtype=xp.complex64)                        |
|   446 |        |       |       |                                                                                            |
|   447 |        |       |       |    # STEP3: precompute constant spectral grids (float32) used each step                    |
|   448 |        |       |       |    ax = state.alfa[None, :]          # (1, NX_half)                                        |
|   449 |        |       |       |    gz = state.gamma[:, None]         # (NZ, 1)                                             |
|   450 |        |       |       |    ax2 = ax * ax                                                                           |
|   451 |        |       |       |    gz2 = gz * gz                                                                           |
|   452 |        |       |       |                                                                                            |
|   453 |        |       |       |    state.step3_K2 = (ax2 + gz2).astype(xp.float32, copy=False)                             |
|   454 |        |       |       |    state.step3_GA = (gz * ax).astype(xp.float32, copy=False)                               |
|   455 |        |       |       |    state.step3_G2mA2 = (gz2 - ax2).astype(xp.float32, copy=False)                          |
|   456 |        |       |       |                                                                                            |
|   457 |        |       |       |    if NX_half > 1:                                                                         |
|   458 |        |       |       |        state.step3_invK2_sub = (xp.float32(1.0) / (state.step3_K2[:, 1:] + xp.float32(1.0e |
|   459 |        |       |       |    else:                                                                                   |
|   460 |        |       |       |        state.step3_invK2_sub = xp.empty((NZ, 0), dtype=xp.float32)                         |
|   461 |        |       |       |                                                                                            |
|   462 |        |       |       |    # STEP3: per-step float/complex scratch (avoid allocating ARG/DEN/NUM each step)        |
|   463 |        |       |       |    state.step3_ARG = xp.empty((NZ, NX_half), dtype=xp.float32)                             |
|   464 |        |       |       |    state.step3_DEN = xp.empty((NZ, NX_half), dtype=xp.float32)                             |
|   465 |        |       |       |    state.step3_NUM = xp.empty((NZ, NX_half), dtype=xp.complex64)                           |
|   466 |        |       |       |                                                                                            |
|   467 |        |       |       |    # ix=0 branch mask (Z>=1 and GAMMA!=0), constant                                        |
|   468 |        |       |       |    state.step3_mask_ix0 = (state.step3_z_indices >= 1) & (xp.abs(state.gamma) > 0.0)       |
|   469 |        |       |       |                                                                                            |
|   470 |        |       |       |    # Precompute safe inv_gamma for ix=0 (avoid xp.divide(where=...) which CuPy rejects her |
|   471 |        |       |       |    mask0 = xp.asarray(state.step3_mask_ix0)  # stays on-GPU for CuPy                       |
|   472 |        |       |       |    safe_gamma = xp.where(mask0, state.gamma, xp.float32(1.0))  # no zeros in denominator   |
|   473 |        |       |       |    inv_gamma0 = (xp.float32(1.0) / safe_gamma).astype(xp.float32, copy=False)              |
|   474 |        |       |       |    inv_gamma0 *= mask0.astype(xp.float32, copy=False)  # zero out invalid lanes            |
|   475 |        |       |       |                                                                                            |
|   476 |        |       |       |    state.step3_mask_ix0 = mask0                                                            |
|   477 |        |       |       |    state.step3_inv_gamma0 = inv_gamma0                                                     |
|   478 |        |       |       |                                                                                            |
|   479 |        |       |       |    # DIVXZ = 1/(3NX/2 * 3NZ/2), constant for fixed N                                       |
|   480 |        |       |       |    NX32 = xp.float32(1.5) * xp.float32(state.Nbase)                                        |
|   481 |        |       |       |    NZ32 = xp.float32(1.5) * xp.float32(state.Nbase)                                        |
|   482 |        |       |       |    state.step3_divxz = xp.float32(1.0) / (NX32 * NZ32)                                     |
|   483 |        |       |       |                                                                                            |
|   484 |        |       |       |    return state                                                                            |
|   485 |        |       |       |                                                                                            |
|   486 |        |       |       |# ===============================================================                           |
|   487 |        |       |       |# Python/Numpy/Scipy port of dnsCudaPaoHostInit, wired into DnsState                        |
|   488 |        |       |       |# ===============================================================                           |
|   489 |        |       |       |def dns_pao_host_init(S: DnsState):                                                         |
|   490 |        |       |       |    xp = S.xp                                                                               |
|   491 |        |       |       |    N = S.NX                                                                                |
|   492 |        |       |       |    NE = S.NZ                                                                               |
|   493 |        |       |       |    ND2 = N // 2                                                                            |
|   494 |        |       |       |    NED2 = NE // 2                                                                          |
|   495 |        |       |       |    PI = np.float32(3.14159265358979)                                                       |
|   496 |        |       |       |                                                                                            |
|   497 |        |       |       |    DXZ = np.float32(2.0) * PI / np.float32(N)                                              |
|   498 |        |       |       |    K0 = np.float32(S.K0)                                                                   |
|   499 |        |       |       |    NORM = PI * K0 * K0                                                                     |
|   500 |        |       |       |                                                                                            |
|   501 |        |       |       |    print("--- INITIALIZING SciPy/CuPy ---", _dt.datetime.now().strftime("%Y-%m-%d %H:%M")) |
|   502 |        |       |       |    print(f" N={N}, K0={int(K0)}, Re={S.Re}")                                               |
|   503 |        |       |       |                                                                                            |
|   504 |        |       |       |    # ------------------------------------------------------------------                    |
|   505 |        |       |       |    # Build ALFA(N/2) and GAMMA(N)  (Fortran DALFA, DGAMMA, E1, E3)                         |
|   506 |        |       |       |    # ------------------------------------------------------------------                    |
|   507 |        |       |       |    alfa = np.zeros(ND2, dtype=np.float32)                                                  |
|   508 |        |       |       |    gamma = np.zeros(NE, dtype=np.float32)                                                  |
|   509 |        |       |       |                                                                                            |
|   510 |        |       |       |    E1 = np.float32(1.0)                                                                    |
|   511 |        |       |       |    E3 = np.float32(1.0) / E1                                                               |
|   512 |        |       |       |                                                                                            |
|   513 |        |       |       |    DALFA = np.float32(1.0) / E1                                                            |
|   514 |        |       |       |    DGAMMA = np.float32(1.0) / E3                                                           |
|   515 |        |       |       |                                                                                            |
|   516 |        |       |       |    for x in range(NED2):                                                                   |
|   517 |        |       |       |        alfa[x] = np.float32(x) * DALFA                                                     |
|   518 |        |       |       |                                                                                            |
|   519 |        |       |       |    gamma[0] = np.float32(0.0)                                                              |
|   520 |        |       |       |    for z in range(1, NED2 + 1):                                                            |
|   521 |        |       |       |        gamma[z] = np.float32(z) * DGAMMA                                                   |
|   522 |        |       |       |        gamma[NE - z] = -gamma[z]                                                           |
|   523 |        |       |       |                                                                                            |
|   524 |        |       |       |    # ------------------------------------------------------------------                    |
|   525 |        |       |       |    # Host spectral UR: complex field UR(kx,z,comp)                                         |
|   526 |        |       |       |    # comp=0 â†’ u1, comp=1 â†’ u3 (Fortran components 1 and 2)                             |
|   527 |        |       |       |    #                                                                                       |
|   528 |        |       |       |    #   UR[x,z,c]  where  x âˆˆ [0..ND2-1], z âˆˆ [0..NE-1], c âˆˆ {0,1}                    |
|   529 |        |       |       |    # ------------------------------------------------------------------                    |
|   530 |        |       |       |    UR = np.zeros((ND2, NE, 2), dtype=np.complex64)                                         |
|   531 |        |       |       |                                                                                            |
|   532 |        |       |       |    # ------------------------------------------------------------------                    |
|   533 |        |       |       |    # Fortran random vector RANVEC(97)                                                      |
|   534 |        |       |       |    # ------------------------------------------------------------------                    |
|   535 |        |       |       |    seed = [int(S.seed_init)]  # mimics ISEED SAVE                                          |
|   536 |        |       |       |    RANVEC = np.zeros(97, dtype=np.float32)                                                 |
|   537 |        |       |       |                                                                                            |
|   538 |        |       |       |    # "warm-up" 97 calls                                                                    |
|   539 |        |       |       |    for _ in range(97):                                                                     |
|   540 |        |       |       |        frand(seed)                                                                         |
|   541 |        |       |       |                                                                                            |
|   542 |        |       |       |    # fill RANVEC                                                                           |
|   543 |        |       |       |    for i in range(97):                                                                     |
|   544 |        |       |       |        RANVEC[i] = frand(seed)                                                             |
|   545 |        |       |       |                                                                                            |
|   546 |        |       |       |    def random_from_vec(r: np.float32) -> np.float32:                                       |
|   547 |        |       |       |        idx = int(float(r) * 97.0)                                                          |
|   548 |        |       |       |        if idx < 0:                                                                         |
|   549 |        |       |       |            idx = 0                                                                         |
|   550 |        |       |       |        if idx > 96:                                                                        |
|   551 |        |       |       |            idx = 96                                                                        |
|   552 |        |       |       |        v = RANVEC[idx]                                                                     |
|   553 |        |       |       |        RANVEC[idx] = r                                                                     |
|   554 |        |       |       |        return v                                                                            |
|   555 |        |       |       |                                                                                            |
|   556 |        |       |       |    # ------------------------------------------------------------------                    |
|   557 |        |       |       |    # Generate isotropic random spectrum (Fortran DO 500/510 loops)                         |
|   558 |        |       |       |    # ------------------------------------------------------------------                    |
|   559 |        |       |       |    print("Generate isotropic random spectrum...")                                          |
|   560 |        |       |       |    for z in range(NE):                                                                     |
|   561 |        |       |       |        if z % 1000 == 0:                                                                   |
|   562 |        |       |       |            print(f"z={z}/{NE}")                                                            |
|   563 |        |       |       |                                                                                            |
|   564 |        |       |       |        gz = gamma[z]                                                                       |
|   565 |        |       |       |        for x in range(NED2):                                                               |
|   566 |        |       |       |            r = frand(seed)                                                                 |
|   567 |        |    1% |       |            th = np.float32(2.0) * PI * random_from_vec(r)                                  |
|   568 |        |       |       |                                                                                            |
|   569 |        |       |       |            ARG = np.complex64(np.cos(th) + 1j * np.sin(th))                                |
|   570 |        |       |       |                                                                                            |
|   571 |        |       |       |            ax = alfa[x]                                                                    |
|   572 |        |    2% |       |            K2 = np.float32(ax * ax + gz * gz)                                              |
|   573 |        |       |       |            K = np.float32(np.sqrt(K2)) if K2 > 0.0 else np.float32(0.0)                    |
|   574 |        |       |       |                                                                                            |
|   575 |        |       |       |            if ax == 0.0:                                                                   |
|   576 |        |       |       |                # ALFA(X) == 0: purely u1 mode                                              |
|   577 |        |       |       |                UR[x, z, 1] = np.complex64(0.0 + 0.0j)                                      |
|   578 |        |       |       |                                                                                            |
|   579 |        |       |       |                ABSU2 = np.float32(np.exp(- (K / K0) * (K / K0)) / NORM)                    |
|   580 |        |       |       |                amp = np.float32(np.sqrt(ABSU2))                                            |
|   581 |        |       |       |                UR[x, z, 0] = np.complex64(amp) * ARG                                       |
|   582 |        |       |       |            else:                                                                           |
|   583 |        |       |       |                denom = np.float32(1.0) + (gz * gz) / (ax * ax)                             |
|   584 |        |       |       |                ABSW2 = np.float32(np.exp(- (K / K0) * (K / K0)) / (denom * NORM))          |
|   585 |        |       |       |                ampw = np.float32(np.sqrt(ABSW2))                                           |
|   586 |        |       |       |                                                                                            |
|   587 |        |       |       |                w = np.complex64(ampw) * ARG                                                |
|   588 |        |       |       |                u = np.complex64(- (gz / ax)) * w  # -GAMMA/ALFA * UR(.,.,2)                |
|   589 |        |       |       |                                                                                            |
|   590 |        |       |       |                UR[x, z, 1] = w                                                             |
|   591 |        |       |       |                UR[x, z, 0] = u                                                             |
|   592 |        |       |       |                                                                                            |
|   593 |        |       |       |    # Special zero modes (UR(1,1,1)=0, UR(1,1,2)=0 in 1-based Fortran)                      |
|   594 |        |       |       |    UR[0, 0, 0] = np.complex64(0.0 + 0.0j)                                                  |
|   595 |        |       |       |    UR[0, 0, 1] = np.complex64(0.0 + 0.0j)                                                  |
|   596 |        |       |       |                                                                                            |
|   597 |        |       |       |    # ------------------------------------------------------------------                    |
|   598 |        |       |       |    # Hermitian symmetry in Z (Fortran DO 600)                                              |
|   599 |        |       |       |    # ------------------------------------------------------------------                    |
|   600 |        |       |       |    for z in range(1, NED2):                                                                |
|   601 |        |       |       |        UR[0, NE - z, 0] = np.conj(UR[0, z, 0])                                             |
|   602 |        |       |       |        UR[0, NE - z, 1] = np.conj(UR[0, z, 1])                                             |
|   603 |        |       |       |                                                                                            |
|   604 |        |       |       |    # Zero at Z=NED2+1 (index NED2 in 0-based)                                              |
|   605 |        |       |       |    UR[:, NED2, 0] = 0.0 + 0.0j                                                             |
|   606 |        |       |       |    UR[:, NED2, 1] = 0.0 + 0.0j                                                             |
|   607 |        |       |       |                                                                                            |
|   608 |        |       |       |    # ------------------------------------------------------------------                    |
|   609 |        |       |       |    # Compute averages A(1..7), E110, Q2, W2, VISC (Fortran DO 800/810)                     |
|   610 |        |       |       |    # ------------------------------------------------------------------                    |
|   611 |        |       |       |    A1 = A2 = A3 = A4 = A5 = A6 = A7 = 0.0                                                  |
|   612 |        |       |       |    E110 = 0.0                                                                              |
|   613 |        |       |       |                                                                                            |
|   614 |        |       |       |    print("Compute averages A(1..7), E110, Q2, W2, VISC...")                                |
|   615 |        |       |       |    for x in range(ND2):                                                                    |
|   616 |        |       |       |        x1 = (x == 0)                                                                       |
|   617 |        |       |       |        ax2 = float(alfa[x]) * float(alfa[x])                                               |
|   618 |        |       |       |                                                                                            |
|   619 |        |       |       |        for z in range(NE):                                                                 |
|   620 |        |       |       |            U1 = UR[x, z, 0]                                                                |
|   621 |        |       |       |            U3 = UR[x, z, 1]                                                                |
|   622 |        |       |       |                                                                                            |
|   623 |        |    1% |       |            u1u1 = float(np.abs(U1) ** 2)                                                   |
|   624 |        |    1% |       |            u3u3 = float(np.abs(U3) ** 2)                                                   |
|   625 |        |       |       |                                                                                            |
|   626 |        |       |       |            gz2 = float(gamma[z]) * float(gamma[z])                                         |
|   627 |        |       |       |            K2 = ax2 + gz2                                                                  |
|   628 |        |       |       |            m = 1.0 if x1 else 2.0                                                          |
|   629 |        |       |       |                                                                                            |
|   630 |        |       |       |            A1 += m * u1u1                                                                  |
|   631 |        |       |       |            A2 += m * u3u3                                                                  |
|   632 |        |       |       |            A3 += m * u1u1 * ax2                                                            |
|   633 |        |       |       |            A4 += m * u1u1 * gz2                                                            |
|   634 |        |       |       |            A5 += m * u3u3 * ax2                                                            |
|   635 |        |       |       |            A6 += m * u3u3 * gz2                                                            |
|   636 |        |       |       |            A7 += m * (u1u1 + u3u3) * K2 * K2                                               |
|   637 |        |       |       |                                                                                            |
|   638 |        |       |       |            if x1:                                                                          |
|   639 |        |       |       |                E110 += u1u1                                                                |
|   640 |        |       |       |                                                                                            |
|   641 |        |       |       |    Q2 = A1 + A2                                                                            |
|   642 |        |       |       |    W2 = A3 + A4 + A5 + A6                                                                  |
|   643 |        |       |       |    visc = math.sqrt(Q2 * Q2 / (float(S.Re) * W2))                                          |
|   644 |        |       |       |                                                                                            |
|   645 |        |       |       |    S.visc = np.float32(visc)                                                               |
|   646 |        |       |       |                                                                                            |
|   647 |        |       |       |    # ------------------------------------------------------------------                    |
|   648 |        |       |       |    # Extra diagnostics (Fortran WRITE block)                                               |
|   649 |        |       |       |    # ------------------------------------------------------------------                    |
|   650 |        |       |       |    EP = visc * W2                                                                          |
|   651 |        |       |       |    De = 2.0 * visc * visc * A7                                                             |
|   652 |        |       |       |    KOL = (visc * visc * visc / EP) ** 0.25                                                 |
|   653 |        |       |       |    NLAM = 0.0                                                                              |
|   654 |        |       |       |    if E110 != 0.0:                                                                         |
|   655 |        |       |       |        NLAM = 2.0 * A1 / E110                                                              |
|   656 |        |       |       |                                                                                            |
|   657 |        |       |       |    a11 = 2.0 * A1 / Q2 - 1.0                                                               |
|   658 |        |       |       |    e11 = 2.0 * (A3 + A4) / W2 - 1.0                                                        |
|   659 |        |       |       |    tscale = 0.5 * Q2 / EP                                                                  |
|   660 |        |       |       |    dxKol = float(DXZ) / KOL                                                                |
|   661 |        |       |       |    Lux = 2.0 * math.pi / math.sqrt(2.0 * A1 / A3)                                          |
|   662 |        |       |       |    Luz = 2.0 * math.pi / math.sqrt(2.0 * A1 / A4)                                          |
|   663 |        |       |       |    Lwx = 2.0 * math.pi / math.sqrt(2.0 * A2 / A5)                                          |
|   664 |        |       |       |    Lwz = 2.0 * math.pi / math.sqrt(2.0 * A2 / A6)                                          |
|   665 |        |       |       |    Ceps2 = 0.5 * Q2 * De / (EP * EP)                                                       |
|   666 |        |       |       |                                                                                            |
|   667 |        |       |       |    # Print diagnostics exactly like the CUDA/Fortran version                               |
|   668 |        |       |       |    print(f" N           ={N:12.0f}")                                                       |
|   669 |        |       |       |    print(f" Reynolds n. ={float(S.Re):12.1g}")                                             |
|   670 |        |       |       |    print(f" K0          ={K0:12.0f}")                                                      |
|   671 |        |       |       |    print(f" Energy      ={Q2:12.4f}")                                                      |
|   672 |        |       |       |    print(f" WiWi        ={W2:12.4f}")                                                      |
|   673 |        |       |       |    print(f" Epsilon     ={EP:12.4f}")                                                      |
|   674 |        |       |       |    print(f" a11         ={a11:12.4f}")                                                     |
|   675 |        |       |       |    print(f" e11         ={e11:12.4f}")                                                     |
|   676 |        |       |       |    print(f" Time scale  ={tscale:12.4g}")                                                  |
|   677 |        |       |       |    print(f" Kolmogorov  ={KOL:12.4f}")                                                     |
|   678 |        |       |       |    print(f" Viscosity   ={visc:12.4f}")                                                    |
|   679 |        |       |       |    print(f" dx/Kol.     ={dxKol:12.4f}")                                                   |
|   680 |        |       |       |    print(f" 2Pi/Nlamda  ={NLAM:12.4f}")                                                    |
|   681 |        |       |       |    print(f" 2Pi/Lux     ={Lux:12.4f}")                                                     |
|   682 |        |       |       |    print(f" 2Pi/Luz     ={Luz:12.4f}")                                                     |
|   683 |        |       |       |    print(f" 2Pi/Lwx     ={Lwx:12.4f}")                                                     |
|   684 |        |       |       |    print(f" 2Pi/Lwz     ={Lwz:12.4f}")                                                     |
|   685 |        |       |       |    print(f" Deps.       ={De:12.4f}")                                                      |
|   686 |        |       |       |    print(f" Ceps2       ={Ceps2:12.4f}")                                                   |
|   687 |        |       |       |    print(f" E1          ={float(E1):12.4f}")                                               |
|   688 |        |       |       |    print(f" E3          ={float(E3):12.4f}")                                               |
|   689 |        |       |       |    print(f" PAO seed    ={seed[0]:12d}")                                                   |
|   690 |        |       |       |                                                                                            |
|   691 |        |       |       |    # ------------------------------------------------------------------                    |
|   692 |        |       |       |    # Reshuffle (Fortran DO 1000 block)                                                     |
|   693 |        |       |       |    # ------------------------------------------------------------------                    |
|   694 |        |       |       |    for comp in range(2):                                                                   |
|   695 |        |       |       |        for z in range(NED2 - 1, -1, -1):                                                   |
|   696 |        |       |       |            for x in range(ND2):                                                            |
|   697 |        |       |       |                # UR(X,N-NED2+Z,I) = UR(X,Z+NED2,I)                                         |
|   698 |        |       |       |                UR[x, N - NED2 + z, comp] = UR[x, z + NED2, comp]                           |
|   699 |        |       |       |                                                                                            |
|   700 |        |       |       |                # IF(Z.LE.(N-NE)) UR(X,Z+NED2,I) = NOLL                                     |
|   701 |        |       |       |                if z <= (N - NE - 1):                                                       |
|   702 |        |       |       |                    UR[x, z + NED2, comp] = 0.0 + 0.0j                                      |
|   703 |        |       |       |                                                                                            |
|   704 |        |       |       |    # ------------------------------------------------------------------                    |
|   705 |        |       |       |    # Scatter spectral UR â†’ compact UC(kx,z,comp) buffer (current grid)                   |
|   706 |        |       |       |    #   UC: (NK, NE, 3) on host, but DnsState.uc is (NZ, NK, 3) in xp                       |
|   707 |        |       |       |    # ------------------------------------------------------------------                    |
|   708 |        |       |       |    NK = S.NK                                                                               |
|   709 |        |       |       |    UC_host = np.zeros((NK, NE, 3), dtype=np.complex64)  # only comp 0,1 used               |
|   710 |        |       |       |                                                                                            |
|   711 |        |       |       |    for z in range(NE):                                                                     |
|   712 |        |       |       |        for x in range(ND2):                                                                |
|   713 |        |       |       |            for c in range(2):                                                              |
|   714 |        |       |       |                UC_host[x, z, c] = UR[x, z, c]                                              |
|   715 |        |       |       |                                                                                            |
|   716 |        |       |       |    # ALSO build full 3/2-grid UC_full (Fortran-like layout)                                |
|   717 |        |       |       |    NK_full = S.NK_full                                                                     |
|   718 |        |       |       |    NZ_full = S.NZ_full                                                                     |
|   719 |        |       |       |                                                                                            |
|   720 |        |       |       |    UC_full_host = np.zeros((NK_full, NZ_full, 3), dtype=np.complex64)                      |
|   721 |        |       |       |    for z in range(NE):                                                                     |
|   722 |        |       |       |        for x in range(ND2):                                                                |
|   723 |        |       |       |            for c in range(2):                                                              |
|   724 |        |       |       |                UC_full_host[x, z, c] = UR[x, z, c]                                         |
|   725 |        |       |       |                                                                                            |
|   726 |        |       |       |    print(f" PAO initialization OK. VISC={float(S.visc):.7g}")                              |
|   727 |        |       |       |                                                                                            |
|   728 |        |       |       |    # ------------------------------------------------------------------                    |
|   729 |        |       |       |    # Move alfa/gamma/UC/UC_full into DnsState (xp backend, SoA layout)                     |
|   730 |        |       |       |    # ------------------------------------------------------------------                    |
|   731 |        |       |       |    S.alfa = xp.asarray(alfa, dtype=xp.float32)                                             |
|   732 |        |       |       |    S.gamma = xp.asarray(gamma, dtype=xp.float32)                                           |
|   733 |        |       |       |                                                                                            |
|   734 |        |       |       |    # compact UC: host (NK, NE, 3) â†’ xp (NZ, NK, 3) with axes swap                        |
|   735 |        |       |       |    UC_xp = xp.asarray(UC_host)                                                             |
|   736 |        |       |       |    S.uc[...] = xp.transpose(UC_xp, (1, 0, 2))  # (NE,NK,3) == (NZ,NK,3)                    |
|   737 |        |       |       |                                                                                            |
|   738 |        |       |       |    # full UC_full: host (NK_full, NZ_full, 3) â†’ xp (3, NZ_full, NK_full)                 |
|   739 |        |       |       |    UC_full_xp = xp.asarray(UC_full_host)                                                   |
|   740 |        |       |       |    S.uc_full[...] = xp.transpose(UC_full_xp, (2, 1, 0))  # (3,NZ_full,NK_full)             |
|   741 |        |       |       |                                                                                            |
|   742 |        |       |       |    # ------------------------------------------------------------------                    |
|   743 |        |       |       |    # Build initial UR_full & om2 from UC_full (for the rest of the solver)                 |
|   744 |        |       |       |    # ------------------------------------------------------------------                    |
|   745 |        |       |       |    # Inverse transform UC_full â†’ UR_full for diagnostics / STEP2B input                  |
|   746 |        |       |       |    vfft_full_inverse_uc_full_to_ur_full(S)                                                 |
|   747 |        |       |       |                                                                                            |
|   748 |        |       |       |    # Spectral vorticity from UC_full, like dnsCudaCalcom                                   |
|   749 |        |       |       |    dns_calcom_from_uc_full(S)                                                              |
|   750 |        |       |       |                                                                                            |
|   751 |        |       |       |    # No history yet                                                                        |
|   752 |        |       |       |    S.fnm1[...] = xp.zeros_like(S.om2)                                                      |
|   753 |        |       |       |                                                                                            |
|   754 |        |       |       |                                                                                            |
|   755 |        |       |       |# ---------------------------------------------------------------------------               |
|   756 |        |       |       |# FFT helpers (vfft_full_* equivalents)                                                     |
|   757 |        |       |       |# ---------------------------------------------------------------------------               |
|   758 |        |       |       |                                                                                            |
|   759 |        |       |       |def vfft_full_inverse_uc_full_to_ur_full(S: DnsState) -> None:                              |
|   760 |        |       |       |    xp = S.xp                                                                               |
|   761 |        |       |       |    UC = S.uc_full                                                                          |
|   762 |        |       |       |    fft = S.fft                                                                             |
|   763 |        |       |       |                                                                                            |
|   764 |        |       |       |    UC01 = UC[0:2, :, :]                                                                    |
|   765 |        |       |       |                                                                                            |
|   766 |        |       |       |    if S.backend == "cpu":                                                                  |
|   767 |        |       |       |        ur01 = fft.irfft2(UC01, s=(S.NZ_full, S.NX_full), axes=(1, 2), overwrite_x=True)    |
|   768 |        |       |       |    else:                                                                                   |
|   769 |        |       |       |        plan = S.fft_plan_irfft2_uc01                                                       |
|   770 |        |       |       |        if plan is not None:                                                                |
|   771 |        |       |       |            with plan:                                                                      |
|   772 |    1%  |    1% |   1%  |                ur01 = fft.irfft2(UC01, s=(S.NZ_full, S.NX_full), axes=(1, 2))              |
|   773 |        |       |       |        else:                                                                               |
|   774 |        |       |       |            ur01 = fft.irfft2(UC01, s=(S.NZ_full, S.NX_full), axes=(1, 2))                  |
|   775 |        |       |       |                                                                                            |
|   776 |        |       |       |    # Match previous STEP2A behavior exactly: scale BEFORE float32 cast/assign.             |
|   777 |        |       |       |    ur01 *= (S.NZ_full * S.NX_full)                                                         |
|   778 |        |       |       |                                                                                            |
|   779 |        |       |       |    S.ur_full[0:2, :, :] = xp.asarray(ur01, dtype=xp.float32)                               |
|   780 |        |       |       |    S.ur_full[2, :, :] = xp.float32(0.0)                                                    |
|   781 |        |       |       |                                                                                            |
|   782 |        |       |       |                                                                                            |
|   783 |        |       |       |def vfft_full_forward_ur_full_to_uc_full(S: DnsState) -> None:                              |
|   784 |        |       |       |    """                                                                                     |
|   785 |        |       |       |    UR_full (3, NZ_full, NX_full) â†’ UC_full (3, NZ_full, NK_full)                         |
|   786 |        |       |       |                                                                                            |
|   787 |        |       |       |    Correct forward:                                                                        |
|   788 |        |       |       |      1) real FFT along x      (real â†’ complex)                                           |
|   789 |        |       |       |      2) FFT along z           (complex â†’ complex)                                        |
|   790 |        |       |       |                                                                                            |
|   791 |        |       |       |    ONLY CHANGE: use rfft2 on (z,x) axes.                                                   |
|   792 |        |       |       |    """                                                                                     |
|   793 |        |       |       |    # S.ur_full is already float32                                                          |
|   794 |        |       |       |    UR = S.ur_full                                                                          |
|   795 |        |       |       |    fft = S.fft                                                                             |
|   796 |        |       |       |                                                                                            |
|   797 |        |       |       |    if S.backend == "cpu":                                                                  |
|   798 |        |       |       |        # overwrite_x is safe here (UR_full is overwritten later by STEP2A anyway)          |
|   799 |        |       |       |        UC = fft.rfft2(UR, s=(S.NZ_full, S.NX_full), axes=(1, 2), overwrite_x=True)         |
|   800 |        |       |       |    else:                                                                                   |
|   801 |        |       |       |        plan = S.fft_plan_rfft2_ur_full                                                     |
|   802 |        |       |       |        if plan is not None:                                                                |
|   803 |        |       |       |            with plan:                                                                      |
|   804 |        |       |       |                UC = fft.rfft2(UR, s=(S.NZ_full, S.NX_full), axes=(1, 2))                   |
|   805 |        |       |       |        else:                                                                               |
|   806 |        |       |       |            UC = fft.rfft2(UR, s=(S.NZ_full, S.NX_full), axes=(1, 2))                       |
|   807 |        |       |       |                                                                                            |
|   808 |        |       |       |    # Assign back; uc_full is complex64, assignment will down-cast if needed                |
|   809 |        |       |       |    S.uc_full[...] = UC                                                                     |
|   810 |        |       |       |                                                                                            |
|   811 |        |       |       |                                                                                            |
|   812 |        |       |       |# ---------------------------------------------------------------------------               |
|   813 |        |       |       |# CALCOM â€” spectral vorticity from UC_full (dnsCudaCalcom)                                |
|   814 |        |       |       |# ---------------------------------------------------------------------------               |
|   815 |        |       |       |                                                                                            |
|   816 |        |       |       |def dns_calcom_from_uc_full(S: DnsState) -> None:                                           |
|   817 |        |       |       |    """                                                                                     |
|   818 |        |       |       |    Python/xp port of dnsCudaCalcom:                                                        |
|   819 |        |       |       |                                                                                            |
|   820 |        |       |       |      OM2(ix,iz) = i * [ GAMMA(iz)*UC1(ix,iz) - ALFA(ix)*UC2(ix,iz) ]                       |
|   821 |        |       |       |                                                                                            |
|   822 |        |       |       |    Uses:                                                                                   |
|   823 |        |       |       |      S.uc_full : (3, NZ_full, NK_full)  [comp,z,kx]                                        |
|   824 |        |       |       |      S.alfa    : (NX_half,)                                                                |
|   825 |        |       |       |      S.gamma   : (NZ,)                                                                     |
|   826 |        |       |       |    Writes:                                                                                 |
|   827 |        |       |       |      S.om2     : (NZ, NX_half)                                                             |
|   828 |        |       |       |    """                                                                                     |
|   829 |        |       |       |    xp = S.xp                                                                               |
|   830 |        |       |       |                                                                                            |
|   831 |        |       |       |    Nbase = int(S.Nbase)                                                                    |
|   832 |        |       |       |    NX_full = int(S.NX_full)                                                                |
|   833 |        |       |       |    NZ_full = int(S.NZ_full)                                                                |
|   834 |        |       |       |    NK_full = int(S.NK_full)                                                                |
|   835 |        |       |       |                                                                                            |
|   836 |        |       |       |    NX_half = Nbase // 2                                                                    |
|   837 |        |       |       |    NZ = Nbase                                                                              |
|   838 |        |       |       |                                                                                            |
|   839 |        |       |       |    alfa_1d = S.alfa.astype(xp.float32)      # (NX_half,)                                   |
|   840 |        |       |       |    gamma_1d = S.gamma.astype(xp.float32)     # (NZ,)                                       |
|   841 |        |       |       |                                                                                            |
|   842 |        |       |       |    # UC_full layout: [comp, z, kx]                                                         |
|   843 |        |       |       |    uc1_full = S.uc_full[0]                   # (NZ_full, NK_full)                          |
|   844 |        |       |       |    uc2_full = S.uc_full[1]                   # (NZ_full, NK_full)                          |
|   845 |        |       |       |                                                                                            |
|   846 |        |       |       |    # We only use the first NZ rows and NX_half kx-modes                                    |
|   847 |        |       |       |    uc1 = uc1_full[:NZ, :NX_half]             # (NZ, NX_half)                               |
|   848 |        |       |       |    uc2 = uc2_full[:NZ, :NX_half]             # (NZ, NX_half)                               |
|   849 |        |       |       |                                                                                            |
|   850 |        |       |       |    ax = alfa_1d[None, :]                     # (1, NX_half)                                |
|   851 |        |       |       |    gz = gamma_1d[:, None]                    # (NZ, 1)                                     |
|   852 |        |       |       |                                                                                            |
|   853 |        |       |       |    # diff = GAMMA*UC1 - ALFA*UC2                                                           |
|   854 |        |       |       |    diff = gz * uc1 - ax * uc2                # (NZ, NX_half), complex                      |
|   855 |        |       |       |                                                                                            |
|   856 |        |       |       |    # om = i * diff = (-Im(diff), Re(diff))                                                 |
|   857 |        |       |       |    diff_r = diff.real                                                                      |
|   858 |        |       |       |    diff_i = diff.imag                                                                      |
|   859 |        |       |       |                                                                                            |
|   860 |        |       |       |    om_r = -diff_i                                                                          |
|   861 |        |       |       |    om_i = diff_r                                                                           |
|   862 |        |       |       |                                                                                            |
|   863 |        |       |       |    S.om2[...] = xp.asarray(om_r + 1j * om_i, dtype=xp.complex64)                           |
|   864 |        |       |       |                                                                                            |
|   865 |        |       |       |                                                                                            |
|   866 |        |       |       |# ---------------------------------------------------------------------------               |
|   867 |        |       |       |# STEP2B â€” build uiuj and forward FFT (dnsCudaStep2B)                                     |
|   868 |        |       |       |# ---------------------------------------------------------------------------               |
|   869 |        |       |       |def dns_step2b(S: DnsState) -> None:                                                        |
|   870 |        |       |       |    """                                                                                     |
|   871 |        |       |       |    Python/CuPy port of dnsCudaStep2B(DnsDeviceState *S).                                   |
|   872 |        |       |       |                                                                                            |
|   873 |        |       |       |    Mirrors Fortran STEP2B:                                                                 |
|   874 |        |       |       |                                                                                            |
|   875 |        |       |       |      1) Build uiuj in UR(x,z,1..3) on the full 3/2 grid                                    |
|   876 |        |       |       |      2) Full-grid forward FFT: UR_full â†’ UC_full (3 components)                          |
|   877 |        |       |       |         (VRFFTF + VCFFTF in Fortran)                                                       |
|   878 |        |       |       |      3) Zero UC(X,NZ+1,I) for X<=NX/2, I=1..3                                              |
|   879 |        |       |       |    """                                                                                     |
|   880 |        |       |       |    xp = S.xp                                                                               |
|   881 |        |       |       |                                                                                            |
|   882 |        |       |       |    # Geometry on the full 3/2 grid                                                         |
|   883 |        |       |       |    N = S.Nbase          # NX = NZ = Nbase (Fortran NX,NZ)                                  |
|   884 |        |       |       |    NX_full = S.NX_full        # 3*N/2                                                      |
|   885 |        |       |       |    NZ_full = S.NZ_full        # 3*N/2                                                      |
|   886 |        |       |       |    NK_full = S.NK_full        # 3*N/4+1                                                    |
|   887 |        |       |       |                                                                                            |
|   888 |        |       |       |    UR = S.ur_full                                                                          |
|   889 |        |       |       |    UC = S.uc_full                                                                          |
|   890 |        |       |       |                                                                                            |
|   891 |        |       |       |    u = UR[0]   # (NZ_full, NX_full)                                                        |
|   892 |        |       |       |    w = UR[1]   # (NZ_full, NX_full)                                                        |
|   893 |        |       |       |                                                                                            |
|   894 |        |       |       |    # Use in-place multiplies to avoid temporaries                                          |
|   895 |        |       |       |    xp.multiply(u, w, out=UR[2])  # u * w                                                   |
|   896 |    1%  |       |       |    xp.multiply(u, u, out=UR[0])  # u^2                                                     |
|   897 |        |       |       |    xp.multiply(w, w, out=UR[1])  # w^2                                                     |
|   898 |        |       |       |                                                                                            |
|   899 |        |       |       |    vfft_full_forward_ur_full_to_uc_full(S)                                                 |
|   900 |        |       |       |                                                                                            |
|   901 |        |       |       |    NX_half = N // 2                                                                        |
|   902 |        |       |       |    NZ = N                                                                                  |
|   903 |        |       |       |    z_mid = NZ                                                                              |
|   904 |        |       |       |                                                                                            |
|   905 |        |       |       |    kx_max = min(NX_half, NK_full)                                                          |
|   906 |        |       |       |                                                                                            |
|   907 |        |       |       |    if z_mid < NZ_full and kx_max > 0:                                                      |
|   908 |        |       |       |        UC[0:3, z_mid, 0:kx_max] = xp.complex64(0.0 + 0.0j)                                 |
|   909 |        |       |       |                                                                                            |
|   910 |        |       |       |                                                                                            |
|   911 |        |       |       |# ---------------------------------------------------------------------------               |
|   912 |        |       |       |# STEP3 â€” vorticity update using om2 & fnm1                                               |
|   913 |        |       |       |# ---------------------------------------------------------------------------               |
|   914 |        |       |       |def dns_step3(S: DnsState) -> None:                                                         |
|   915 |        |       |       |    xp = S.xp                                                                               |
|   916 |        |       |       |                                                                                            |
|   917 |        |       |       |    om2 = S.om2                                                                             |
|   918 |        |       |       |    fnm1 = S.fnm1                                                                           |
|   919 |        |       |       |    alfa = S.alfa                                                                           |
|   920 |        |       |       |    gamma = S.gamma                                                                         |
|   921 |        |       |       |    uc_full = S.uc_full                                                                     |
|   922 |        |       |       |                                                                                            |
|   923 |        |       |       |    Nbase = int(S.Nbase)                                                                    |
|   924 |        |       |       |    NX_half = Nbase // 2                                                                    |
|   925 |        |       |       |    NZ = Nbase                                                                              |
|   926 |        |       |       |                                                                                            |
|   927 |        |       |       |    visc = xp.float32(S.visc)                                                               |
|   928 |        |       |       |    dt = xp.float32(S.dt)                                                                   |
|   929 |        |       |       |    cn = xp.float32(S.cn)                                                                   |
|   930 |        |       |       |    cnm1 = xp.float32(S.cnm1)                                                               |
|   931 |        |       |       |                                                                                            |
|   932 |        |       |       |    z_spec = S.step3_z_spec                                                                 |
|   933 |        |       |       |    divxz = S.step3_divxz                                                                   |
|   934 |        |       |       |    GA = S.step3_GA                                                                         |
|   935 |        |       |       |    G2mA2 = S.step3_G2mA2                                                                   |
|   936 |        |       |       |    K2 = S.step3_K2                                                                         |
|   937 |        |       |       |                                                                                            |
|   938 |        |       |       |    uc0_low = uc_full[0, :, :NX_half]                                                       |
|   939 |        |       |       |    uc1_low = uc_full[1, :, :NX_half]                                                       |
|   940 |        |       |       |    uc2_low = uc_full[2, :, :NX_half]                                                       |
|   941 |        |       |       |                                                                                            |
|   942 |        |       |       |    uc1_th = S.step3_uc1_th                                                                 |
|   943 |        |       |       |    uc2_th = S.step3_uc2_th                                                                 |
|   944 |        |       |       |    uc3_th = S.step3_uc3_th                                                                 |
|   945 |        |       |       |    xp.take(uc0_low, z_spec, axis=0, out=uc1_th)                                            |
|   946 |        |       |       |    xp.take(uc1_low, z_spec, axis=0, out=uc2_th)                                            |
|   947 |        |       |       |    xp.take(uc2_low, z_spec, axis=0, out=uc3_th)                                            |
|   948 |        |       |       |                                                                                            |
|   949 |        |       |       |    tmp_FN = S.scratch1                                                                     |
|   950 |        |       |       |    tmp_c = S.scratch2                                                                      |
|   951 |        |       |       |    xp.subtract(uc1_th, uc2_th, out=tmp_FN)                                                 |
|   952 |        |       |       |    xp.multiply(tmp_FN, GA, out=tmp_FN)                                                     |
|   953 |        |       |       |    xp.multiply(uc3_th, G2mA2, out=tmp_c)                                                   |
|   954 |        |       |       |    xp.add(tmp_FN, tmp_c, out=tmp_FN)                                                       |
|   955 |        |       |       |    tmp_FN *= divxz                                                                         |
|   956 |        |       |       |                                                                                            |
|   957 |        |       |       |    VT = xp.float32(0.5) * visc * dt                                                        |
|   958 |        |       |       |    ARG = S.step3_ARG                                                                       |
|   959 |        |       |       |    DEN = S.step3_DEN                                                                       |
|   960 |        |       |       |    xp.multiply(K2, VT, out=ARG)                                                            |
|   961 |        |       |       |    xp.add(ARG, xp.float32(1.0), out=DEN)                                                   |
|   962 |        |       |       |                                                                                            |
|   963 |        |       |       |    c2 = xp.float32(0.5) * dt * (xp.float32(2.0) + cnm1)                                    |
|   964 |        |       |       |    c3 = -xp.float32(0.5) * dt * cnm1                                                       |
|   965 |        |       |       |                                                                                            |
|   966 |        |       |       |    NUM = S.step3_NUM                                                                       |
|   967 |        |       |       |    NUM[...] = om2                                                                          |
|   968 |        |       |       |    xp.multiply(om2, ARG, out=tmp_c)                                                        |
|   969 |        |       |       |    NUM -= tmp_c                                                                            |
|   970 |        |       |       |                                                                                            |
|   971 |        |       |       |    xp.multiply(tmp_FN, c2, out=tmp_c)                                                      |
|   972 |        |       |       |    NUM += tmp_c                                                                            |
|   973 |        |       |   1%  |    xp.multiply(fnm1, c3, out=tmp_c)                                                        |
|   974 |        |       |       |    NUM += tmp_c                                                                            |
|   975 |        |       |       |                                                                                            |
|   976 |        |       |       |    xp.divide(NUM, DEN, out=om2)                                                            |
|   977 |        |       |       |                                                                                            |
|   978 |        |       |       |    fnm1[...] = tmp_FN                                                                      |
|   979 |        |       |       |                                                                                            |
|   980 |        |       |       |    out1 = S.scratch1                                                                       |
|   981 |        |       |       |    out2 = S.scratch2                                                                       |
|   982 |        |       |       |    out1[...] = 0                                                                           |
|   983 |        |       |       |    out2[...] = 0                                                                           |
|   984 |        |       |       |                                                                                            |
|   985 |        |       |       |    if NX_half > 1:                                                                         |
|   986 |        |       |       |        invK2_sub = S.step3_invK2_sub                                                       |
|   987 |        |       |       |                                                                                            |
|   988 |        |       |       |        out1[:, 1:] = om2[:, 1:]                                                            |
|   989 |        |       |       |        out1[:, 1:] *= invK2_sub                                                            |
|   990 |        |       |       |        out1[:, 1:] *= gamma[:, None]                                                       |
|   991 |    1%  |       |   1%  |        out1[:, 1:] *= xp.complex64(-1.0j)                                                  |
|   992 |        |       |       |                                                                                            |
|   993 |        |       |       |        out2[:, 1:] = om2[:, 1:]                                                            |
|   994 |        |       |       |        out2[:, 1:] *= invK2_sub                                                            |
|   995 |        |       |       |        out2[:, 1:] *= alfa[1:][None, :]                                                    |
|   996 |        |       |       |        out2[:, 1:] *= xp.complex64(1.0j)                                                   |
|   997 |        |       |       |                                                                                            |
|   998 |        |       |       |    # GPU-optimized ix=0 branch: no fancy indexing gather/scatter                           |
|   999 |        |       |       |    out1[:, 0] = 0                                                                          |
|  1000 |    1%  |       |   1%  |    out1[:, 0] = xp.complex64(-1.0j) * om2[:, 0] * S.step3_inv_gamma0                       |
|  1001 |        |       |       |                                                                                            |
|  1002 |        |       |       |    uc_full[0, :NZ, :NX_half] = out1                                                        |
|  1003 |        |       |       |    uc_full[1, :NZ, :NX_half] = out2                                                        |
|  1004 |        |       |       |                                                                                            |
|  1005 |        |       |       |    S.cnm1 = float(cn)                                                                      |
|  1006 |        |       |       |                                                                                            |
|  1007 |        |       |       |                                                                                            |
|  1008 |        |       |       |# ===============================================================                           |
|  1009 |        |       |       |# STEP2A core (dealias + reshuffle + inverse FFT)                                           |
|  1010 |        |       |       |# ===============================================================                           |
|  1011 |        |       |       |def dns_step2a(S: DnsState) -> None:                                                        |
|  1012 |        |       |       |    xp = S.xp                                                                               |
|  1013 |        |       |       |    N = S.Nbase                                                                             |
|  1014 |        |       |       |    NX = S.NX                                                                               |
|  1015 |        |       |       |    NZ = S.NZ                                                                               |
|  1016 |        |       |       |    NX_full = S.NX_full                                                                     |
|  1017 |        |       |       |    NZ_full = S.NZ_full                                                                     |
|  1018 |        |       |       |    NK_full = S.NK_full                                                                     |
|  1019 |        |       |       |                                                                                            |
|  1020 |        |       |       |    UC = S.uc_full                                                                          |
|  1021 |        |       |       |                                                                                            |
|  1022 |        |       |       |    hi_start = N // 2                                                                       |
|  1023 |        |       |       |    hi_end = min(3 * N // 4, NK_full - 1)                                                   |
|  1024 |        |       |       |    if hi_start <= hi_end:                                                                  |
|  1025 |        |       |       |        UC[0:2, :, hi_start:hi_end + 1] = xp.complex64(0.0 + 0.0j)                          |
|  1026 |        |       |       |                                                                                            |
|  1027 |        |       |       |    halfN = N // 2                                                                          |
|  1028 |        |       |       |    k_max = min(halfN, NK_full)                                                             |
|  1029 |        |       |       |    if k_max > 0:                                                                           |
|  1030 |        |       |       |        z_mid_start = halfN                                                                 |
|  1031 |        |       |       |        z_mid_end = N                                                                       |
|  1032 |        |       |       |        z_top_start = N                                                                     |
|  1033 |        |       |       |        z_top_end = N + halfN                                                               |
|  1034 |        |       |       |        UC[0:2, z_top_start:z_top_end, :k_max] = UC[0:2, z_mid_start:z_mid_end, :k_max]     |
|  1035 |        |       |       |        UC[0:2, z_mid_start:z_mid_end, :k_max] = xp.complex64(0.0 + 0.0j)                   |
|  1036 |        |       |       |                                                                                            |
|  1037 |        |       |       |    # Inverse FFT UC_full â†’ UR_full                                                       |
|  1038 |        |       |       |    vfft_full_inverse_uc_full_to_ur_full(S)                                                 |
|  1039 |        |       |       |                                                                                            |
|  1040 |        |       |       |    off_x = (NX_full - NX) // 2                                                             |
|  1041 |        |       |       |    off_z = (NZ_full - NZ) // 2                                                             |
|  1042 |        |       |       |                                                                                            |
|  1043 |        |       |       |    S.ur[:, :, 0] = S.ur_full[0, off_z:off_z + N, off_x:off_x + N]                          |
|  1044 |        |       |       |    S.ur[:, :, 1] = S.ur_full[1, off_z:off_z + N, off_x:off_x + N]                          |
|  1045 |        |       |       |    S.ur[:, :, 2] = 0.0                                                                     |
|  1046 |        |       |       |                                                                                            |
|  1047 |        |       |       |                                                                                            |
|  1048 |        |       |       |# ---------------------------------------------------------------------------               |
|  1049 |        |       |       |# NEXTDT â€” CFL based timestep                                                             |
|  1050 |        |       |       |# ---------------------------------------------------------------------------               |
|  1051 |        |       |       |                                                                                            |
|  1052 |        |       |       |def compute_cflm(S: DnsState):                                                              |
|  1053 |        |       |       |    xp = S.xp                                                                               |
|  1054 |        |       |       |    NX3D2 = S.NX_full                                                                       |
|  1055 |        |       |       |    NZ3D2 = S.NZ_full                                                                       |
|  1056 |        |       |       |                                                                                            |
|  1057 |        |       |       |    u = S.ur_full[0, :NZ3D2, :NX3D2]                                                        |
|  1058 |        |       |       |    w = S.ur_full[1, :NZ3D2, :NX3D2]                                                        |
|  1059 |        |       |       |                                                                                            |
|  1060 |        |       |       |    if S.backend == "gpu" and _cflm_max_abs_sum is not None:                                |
|  1061 |        |       |       |        CFLM = _cflm_max_abs_sum(u, w) * xp.float32(S.inv_dx)  # GPU scalar                 |
|  1062 |        |       |       |        return CFLM                                                                         |
|  1063 |        |       |       |                                                                                            |
|  1064 |        |       |       |    # CPU (or fallback): keep current code path                                             |
|  1065 |        |       |       |    tmp = S.cfl_tmp[:NZ3D2, :NX3D2]                                                         |
|  1066 |        |       |       |    absw = S.cfl_absw[:NZ3D2, :NX3D2]                                                       |
|  1067 |        |       |       |    xp.abs(u, out=tmp)                                                                      |
|  1068 |        |       |       |    xp.abs(w, out=absw)                                                                     |
|  1069 |        |       |       |    xp.add(tmp, absw, out=tmp)                                                              |
|  1070 |        |       |       |    CFLM = xp.max(tmp) * S.inv_dx                                                           |
|  1071 |        |       |       |    return float(CFLM) if S.backend == "cpu" else CFLM                                      |
|  1072 |        |       |       |                                                                                            |
|  1073 |        |       |       |def next_dt(S: DnsState) -> None:                                                           |
|  1074 |        |       |       |    PI = math.pi                                                                            |
|  1075 |        |       |       |    CFLM = compute_cflm(S)                                                                  |
|  1076 |        |       |       |                                                                                            |
|  1077 |        |       |       |    if S.backend == "gpu":                                                                  |
|  1078 |    4%  |   20% |   6%  |        CFLM = float(CFLM)  # one sync here, but only when next_dt is called                |
|  1079 |        |       |       |                                                                                            |
|  1080 |        |       |       |    if CFLM <= 0.0 or S.dt <= 0.0:                                                          |
|  1081 |        |       |       |        return                                                                              |
|  1082 |        |       |       |                                                                                            |
|  1083 |        |       |       |    CFL = CFLM * S.dt * PI                                                                  |
|  1084 |        |       |       |    S.cn = 0.8 + 0.2 * (S.cflnum / CFL)                                                     |
|  1085 |        |       |       |    S.dt = S.dt * S.cn                                                                      |
|  1086 |        |       |       |                                                                                            |
|  1087 |        |       |       |                                                                                            |
|  1088 |        |       |       |# ===============================================================                           |
|  1089 |        |       |       |# Python equivalent of dnsCudaDumpFieldAsPGMFull                                            |
|  1090 |        |       |       |# ===============================================================                           |
|  1091 |        |       |       |def dump_field_as_pgm_full(S: DnsState, comp: int, filename: str) -> None:                  |
|  1092 |        |       |       |    NX_full = S.NX_full                                                                     |
|  1093 |        |       |       |    NZ_full = S.NZ_full                                                                     |
|  1094 |        |       |       |                                                                                            |
|  1095 |        |       |       |    if S.backend == "gpu":                                                                  |
|  1096 |        |       |       |        ur_full_host = _np.asarray(S.ur_full.get(), dtype=_np.float32)                      |
|  1097 |        |       |       |    else:                                                                                   |
|  1098 |        |       |       |        ur_full_host = _np.asarray(S.ur_full, dtype=_np.float32)                            |
|  1099 |        |       |       |                                                                                            |
|  1100 |        |       |       |    field = ur_full_host[comp, :, :]                                                        |
|  1101 |        |       |       |                                                                                            |
|  1102 |        |       |       |    minv = float(field.min())                                                               |
|  1103 |        |       |       |    maxv = float(field.max())                                                               |
|  1104 |        |       |       |                                                                                            |
|  1105 |        |       |       |    try:                                                                                    |
|  1106 |        |       |       |        f = open(filename, "wb")                                                            |
|  1107 |        |       |       |    except OSError as e:                                                                    |
|  1108 |        |       |       |        print(f"[DUMP] fopen failed for {filename!r}: {e}")                                 |
|  1109 |        |       |       |        return                                                                              |
|  1110 |        |       |       |                                                                                            |
|  1111 |        |       |       |    header = f"P5\n{NX_full} {NZ_full}\n255\n"                                              |
|  1112 |        |       |       |    f.write(header.encode("ascii"))                                                         |
|  1113 |        |       |       |                                                                                            |
|  1114 |        |       |       |    rng = maxv - minv                                                                       |
|  1115 |        |       |       |                                                                                            |
|  1116 |        |       |       |    if abs(rng) <= 1.0e-12:                                                                 |
|  1117 |        |       |       |        c = bytes([128])                                                                    |
|  1118 |        |       |       |        row = c * NX_full                                                                   |
|  1119 |        |       |       |        for _ in range(NZ_full):                                                            |
|  1120 |        |       |       |            f.write(row)                                                                    |
|  1121 |        |       |       |    else:                                                                                   |
|  1122 |        |       |       |        for j in range(NZ_full):                                                            |
|  1123 |        |       |       |            for i in range(NX_full):                                                        |
|  1124 |        |       |       |                val = float(field[j, i])                                                    |
|  1125 |        |       |       |                norm = (val - minv) / rng                                                   |
|  1126 |        |       |       |                pixf = 1.0 + norm * 254.0                                                   |
|  1127 |        |       |       |                pix = int(pixf + 0.5)                                                       |
|  1128 |        |       |       |                if pix < 1:                                                                 |
|  1129 |        |       |       |                    pix = 1                                                                 |
|  1130 |        |       |       |                if pix > 255:                                                               |
|  1131 |        |       |       |                    pix = 255                                                               |
|  1132 |        |       |       |                f.write(bytes([pix]))                                                       |
|  1133 |        |       |       |                                                                                            |
|  1134 |        |       |       |    f.close()                                                                               |
|  1135 |        |       |       |    print(f"[DUMP] Wrote {filename} (PGM, {NX_full}x{NZ_full}, "                            |
|  1136 |        |       |       |          f"comp={comp}, min={minv:g}, max={maxv:g})")                                      |
|  1137 |        |       |       |                                                                                            |
|  1138 |        |       |       |                                                                                            |
|  1139 |        |       |       |# ---------------------------------------------------------------------------               |
|  1140 |        |       |       |# Helpers for visualization fields (energy, vorticity, streamfunction)                      |
|  1141 |        |       |       |# ---------------------------------------------------------------------------               |
|  1142 |        |       |       |                                                                                            |
|  1143 |        |       |       |def dns_kinetic(S: DnsState) -> None:                                                       |
|  1144 |        |       |       |    xp = S.xp                                                                               |
|  1145 |        |       |       |                                                                                            |
|  1146 |        |       |       |    u = S.ur_full[0, :, :]                                                                  |
|  1147 |        |       |       |    w = S.ur_full[1, :, :]                                                                  |
|  1148 |        |       |       |                                                                                            |
|  1149 |        |       |       |    ke = xp.sqrt(u * u + w * w)                                                             |
|  1150 |        |       |       |    S.ur_full[2, :, :] = ke.astype(xp.float32)                                              |
|  1151 |        |       |       |                                                                                            |
|  1152 |        |       |       |                                                                                            |
|  1153 |        |       |       |def _spectral_band_to_phys_full_grid(S: DnsState, band) -> any:                             |
|  1154 |        |       |       |    xp = S.xp                                                                               |
|  1155 |        |       |       |                                                                                            |
|  1156 |        |       |       |    N = S.Nbase                                                                             |
|  1157 |        |       |       |    NX_full = S.NX_full                                                                     |
|  1158 |        |       |       |    NZ_full = S.NZ_full                                                                     |
|  1159 |        |       |       |    NK_full = S.NK_full                                                                     |
|  1160 |        |       |       |                                                                                            |
|  1161 |        |       |       |    NX_half = N // 2                                                                        |
|  1162 |        |       |       |    NZ = N                                                                                  |
|  1163 |        |       |       |                                                                                            |
|  1164 |        |       |       |    uc_tmp = xp.zeros((NZ_full, NK_full), dtype=xp.complex64)                               |
|  1165 |        |       |       |    uc_tmp[:NZ, :NX_half] = band                                                            |
|  1166 |        |       |       |                                                                                            |
|  1167 |        |       |       |    hi_start = N // 2                                                                       |
|  1168 |        |       |       |    hi_end = min(3 * N // 4, NK_full - 1)                                                   |
|  1169 |        |       |       |    if hi_start <= hi_end:                                                                  |
|  1170 |        |       |       |        uc_tmp[:, hi_start:hi_end + 1] = xp.complex64(0.0 + 0.0j)                           |
|  1171 |        |       |       |                                                                                            |
|  1172 |        |       |       |    halfN = N // 2                                                                          |
|  1173 |        |       |       |    k_max = min(halfN, NK_full)                                                             |
|  1174 |        |       |       |                                                                                            |
|  1175 |        |       |       |    if k_max > 0:                                                                           |
|  1176 |        |       |       |        z_mid_start = halfN                                                                 |
|  1177 |        |       |       |        z_mid_end = halfN + halfN                                                           |
|  1178 |        |       |       |        z_top_start = N                                                                     |
|  1179 |        |       |       |        z_top_end = N + halfN                                                               |
|  1180 |        |       |       |                                                                                            |
|  1181 |        |       |       |        uc_tmp[z_top_start:z_top_end, :k_max] = uc_tmp[z_mid_start:z_mid_end, :k_max]       |
|  1182 |        |       |       |        uc_tmp[z_mid_start:z_mid_end, :k_max] = xp.complex64(0.0 + 0.0j)                    |
|  1183 |        |       |       |                                                                                            |
|  1184 |        |       |       |    z_mid = NZ                                                                              |
|  1185 |        |       |       |    if z_mid < NZ_full:                                                                     |
|  1186 |        |       |       |        uc_tmp[z_mid, :NX_half] = xp.complex64(0.0 + 0.0j)                                  |
|  1187 |        |       |       |                                                                                            |
|  1188 |        |       |       |    fft = S.fft                                                                             |
|  1189 |        |       |       |                                                                                            |
|  1190 |        |       |       |    if S.backend == "cpu":                                                                  |
|  1191 |        |       |       |        phys = fft.irfft2(uc_tmp, s=(NZ_full, NX_full), axes=(0, 1), overwrite_x=True)      |
|  1192 |        |       |       |    else:                                                                                   |
|  1193 |        |       |       |        phys = fft.irfft2(uc_tmp, s=(NZ_full, NX_full), axes=(0, 1))                        |
|  1194 |        |       |       |                                                                                            |
|  1195 |        |       |       |    phys *= (NZ_full * NX_full)                                                             |
|  1196 |        |       |       |    return xp.asarray(phys, dtype=xp.float32)                                               |
|  1197 |        |       |       |                                                                                            |
|  1198 |        |       |       |                                                                                            |
|  1199 |        |       |       |def dns_om2_phys(S: DnsState) -> None:                                                      |
|  1200 |        |       |       |    band = S.om2                                                                            |
|  1201 |        |       |       |    phys = _spectral_band_to_phys_full_grid(S, band)                                        |
|  1202 |        |       |       |    S.ur_full[2, :, :] = phys                                                               |
|  1203 |        |       |       |                                                                                            |
|  1204 |        |       |       |                                                                                            |
|  1205 |        |       |       |def dns_stream_func(S: DnsState) -> None:                                                   |
|  1206 |        |       |       |    xp = S.xp                                                                               |
|  1207 |        |       |       |                                                                                            |
|  1208 |        |       |       |    N = S.Nbase                                                                             |
|  1209 |        |       |       |    NX_half = N // 2                                                                        |
|  1210 |        |       |       |    NZ = N                                                                                  |
|  1211 |        |       |       |                                                                                            |
|  1212 |        |       |       |    alfa_1d = S.alfa.astype(xp.float32)                                                     |
|  1213 |        |       |       |    gamma_1d = S.gamma.astype(xp.float32)                                                   |
|  1214 |        |       |       |                                                                                            |
|  1215 |        |       |       |    ax = alfa_1d[None, :]                                                                   |
|  1216 |        |       |       |    gz = gamma_1d[:, None]                                                                  |
|  1217 |        |       |       |                                                                                            |
|  1218 |        |       |       |    K2 = ax * ax + gz * gz                                                                  |
|  1219 |        |       |       |    K2 = K2 + xp.float32(1.0e-30)                                                           |
|  1220 |        |       |       |                                                                                            |
|  1221 |        |       |       |    phi_hat = S.om2 / K2                                                                    |
|  1222 |        |       |       |    phys = _spectral_band_to_phys_full_grid(S, phi_hat)                                     |
|  1223 |        |       |       |    S.ur_full[2, :, :] = phys                                                               |
|  1224 |        |       |       |                                                                                            |
|  1225 |        |       |       |                                                                                            |
|  1226 |        |       |       |# ---------------------------------------------------------------------------               |
|  1227 |        |       |       |# Main driver (Python version of main in dns_all.cu)                                        |
|  1228 |        |       |       |# ---------------------------------------------------------------------------               |
|  1229 |        |       |       |def run_dns(                                                                                |
|  1230 |        |       |       |    N: int = 8,                                                                             |
|  1231 |        |       |       |    Re: float = 100,                                                                        |
|  1232 |        |       |       |    K0: float = 10.0,                                                                       |
|  1233 |        |       |       |    STEPS: int = 2,                                                                         |
|  1234 |        |       |       |    CFL: float = 0.75,                                                                      |
|  1235 |        |       |       |    backend: Literal["cpu", "gpu", "auto"] = "auto",                                        |
|  1236 |        |       |       |) -> None:                                                                                  |
|  1237 |        |       |       |    print("--- RUN DNS ---")                                                                |
|  1238 |        |       |       |    print(f" N   = {N}")                                                                    |
|  1239 |        |       |       |    print(f" Re  = {Re}")                                                                   |
|  1240 |        |       |       |    print(f" K0  = {K0}")                                                                   |
|  1241 |        |       |       |    print(f" Steps = {STEPS}")                                                              |
|  1242 |        |       |       |    print(f" CFL  = {CFL}")                                                                 |
|  1243 |        |       |       |    print(f" requested = {backend}")                                                        |
|  1244 |        |       |       |                                                                                            |
|  1245 |        |       |       |    S = create_dns_state(N=N, Re=Re, K0=K0, CFL=CFL, backend=backend)                       |
|  1246 |        |       |       |    print(f" effective = {S.backend} (xp = {'cupy' if S.backend == 'gpu' else 'scipy'})")   |
|  1247 |        |       |       |                                                                                            |
|  1248 |        |       |       |    if S.backend == "cpu" and _spfft is not None and S.fft_workers > 1:                     |
|  1249 |        |       |       |        fft_ctx = _spfft.set_workers(S.fft_workers)                                         |
|  1250 |        |       |       |    else:                                                                                   |
|  1251 |        |       |       |        fft_ctx = nullcontext()                                                             |
|  1252 |        |       |       |                                                                                            |
|  1253 |        |       |       |    with fft_ctx:                                                                           |
|  1254 |        |       |       |        if _spfft is not None:                                                              |
|  1255 |        |       |       |            print(f" scipy.fft workers in-context = {_spfft.get_workers()}")                |
|  1256 |        |       |       |        else:                                                                               |
|  1257 |        |       |       |            print(" scipy.fft workers in-context = n/a (gpu or scipy.fft missing)")         |
|  1258 |        |       |       |                                                                                            |
|  1259 |        |       |       |        dns_step2a(S)                                                                       |
|  1260 |        |       |       |                                                                                            |
|  1261 |        |       |       |        CFLM = compute_cflm(S)                                                              |
|  1262 |        |       |       |        if S.backend == "gpu":                                                              |
|  1263 |        |       |       |            CFLM0 = float(CFLM)  # one sync here at init (fine)                             |
|  1264 |        |       |       |        else:                                                                               |
|  1265 |        |       |       |            CFLM0 = float(CFLM)                                                             |
|  1266 |        |       |       |                                                                                            |
|  1267 |        |       |       |        S.dt = S.cflnum / (CFLM0 * math.pi)                                                 |
|  1268 |        |       |       |        S.cn = 1.0                                                                          |
|  1269 |        |       |       |        S.cnm1 = 0.0                                                                        |
|  1270 |        |       |       |        S.t = 0.0                                                                           |
|  1271 |        |       |       |                                                                                            |
|  1272 |        |       |       |        print(f" [NEXTDT INIT] CFLM={CFLM0:11.4f} DT={S.dt:11.7f} CN={S.cn:11.7f}")         |
|  1273 |        |       |       |        print(f" Initial DT={S.dt:11.7f} CN={S.cn:11.7f}")                                  |
|  1274 |        |       |       |                                                                                            |
|  1275 |        |       |       |        S.sync()                                                                            |
|  1276 |        |       |       |        t0 = time.perf_counter()                                                            |
|  1277 |        |       |       |                                                                                            |
|  1278 |        |       |       |        for it in range(1, STEPS + 1):                                                      |
|  1279 |        |       |       |            S.it = it                                                                       |
|  1280 |        |       |       |            dt_old = S.dt                                                                   |
|  1281 |        |       |       |            dns_step2b(S)                                                                   |
|  1282 |        |       |       |            dns_step3(S)                                                                    |
|  1283 |        |       |       |            dns_step2a(S)                                                                   |
|  1284 |        |       |       |            if (it % 100) == 0 or it == 1 or it == STEPS:                                   |
|  1285 |        |       |       |                next_dt(S)                                                                  |
|  1286 |        |       |       |                print(f" ITERATION {it:6d} T={S.t:12.10f} DT={S.dt:10.8f} CN={S.cn:10.8f} C |
|  1287 |        |       |       |            S.t += dt_old                                                                   |
|  1288 |        |       |       |                                                                                            |
|  1289 |        |       |       |        S.sync()                                                                            |
|  1290 |        |       |       |        t1 = time.perf_counter()                                                            |
|  1291 |        |       |       |                                                                                            |
|  1292 |        |       |       |        elap = t1 - t0                                                                      |
|  1293 |        |       |       |        fps = (STEPS / elap) if elap > 0 else 0.0                                           |
|  1294 |        |       |       |                                                                                            |
|  1295 |        |       |       |        print(f" Elapsed CPU time for {STEPS} steps (s) = {elap:8g}")                       |
|  1296 |        |       |       |        print(f" Final T={S.t:8g}  CN={S.cn:8g}  DT={S.dt:8g}")                             |
|  1297 |        |       |       |        print(f" FPS = {fps:7g}")                                                           |
|  1298 |        |       |       |                                                                                            |
|  1299 |        |       |       |def main():                                                                                 |
|  1300 |        |       |       |    args = sys.argv[1:]                                                                     |
|  1301 |        |       |       |    N = int(args[0]) if len(args) > 0 else 512                                              |
|  1302 |        |       |       |    Re = float(args[1]) if len(args) > 1 else 10000                                         |
|  1303 |        |       |       |    K0 = float(args[2]) if len(args) > 2 else 10.0                                          |
|  1304 |        |       |       |    STEPS = int(args[3]) if len(args) > 3 else 101                                          |
|  1305 |        |       |       |    CFL = float(args[4]) if len(args) > 4 else 0.75                                         |
|  1306 |        |       |       |                                                                                            |
|  1307 |        |       |       |    BACK = args[5].lower() if len(args) > 5 else "auto"                                     |
|  1308 |        |       |       |    if BACK not in ("cpu", "gpu", "auto"):                                                  |
|  1309 |        |       |       |        BACK = "auto"                                                                       |
|  1310 |        |       |       |                                                                                            |
|  1311 |        |       |       |    run_dns(N=N, Re=Re, K0=K0, STEPS=STEPS, CFL=CFL, backend=BACK)                          |
|  1312 |        |       |       |                                                                                            |
|  1313 |        |       |       |                                                                                            |
|  1314 |        |       |       |if __name__ == "__main__":                                                                  |
|  1315 |        |       |       |    main()                                                                                  |
|       |        |       |       |                                                                                            |
|-------+--------+-------+-------+--------------------------------------------------------------------------------------------|
|       |        |       |       |function summary for C:\Users\tobbe\python\cupyxturbo\scipyturbo\turbo_simulator_cufft.py   |
|    90 |        |       |       |frand                                                                                       |
|   315 |        |       |       |create_dns_state                                                                            |
|   489 |    6%  |   11% |       |dns_pao_host_init                                                                           |
|   546 |        |       |       |dns_pao_host_init.<locals>.random_from_vec                                                  |
|   759 |    3%  |    2% |   3%  |vfft_full_inverse_uc_full_to_ur_full                                                        |
|   783 |        |       |       |vfft_full_forward_ur_full_to_uc_full                                                        |
|   816 |        |       |       |dns_calcom_from_uc_full                                                                     |
|   869 |    2%  |    1% |   2%  |dns_step2b                                                                                  |
|   914 |   10%  |    6% |  11%  |dns_step3                                                                                   |
|  1011 |    2%  |    1% |   2%  |dns_step2a                                                                                  |
|  1073 |    4%  |   20% |   6%  |next_dt                                                                                     |
|  1229 |        |       |       |run_dns                                                                                     |
+-----------------------------------------------------------------------------------------------------------------------------+
(mannetroll-cupyxturbo)
tobbe@fractal MINGW64 ~/python/cupyxturbo (main)
$
